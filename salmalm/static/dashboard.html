<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SalmAlm Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0f172a;--bg2:#1e293b;--text:#e2e8f0;--text2:#94a3b8;--accent:#6366f1;--border:#334155;--green:#22c55e;--red:#ef4444;--yellow:#eab308}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;padding:20px}
h1{font-size:24px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
.card h3{font-size:14px;color:var(--text2);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}
.big-num{font-size:36px;font-weight:700;color:var(--accent)}
.stat-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
.stat-row:last-child{border:none}
.stat-label{color:var(--text2)}
.badge{display:inline-block;padding:2px 8px;border-radius:99px;font-size:11px;font-weight:600}
.badge-green{background:#22c55e22;color:var(--green)}
.badge-yellow{background:#eab30822;color:var(--yellow)}
.badge-red{background:#ef444422;color:var(--red)}
.chart-wrap{height:200px;position:relative}
a.back{color:var(--accent);text-decoration:none;font-size:13px}
.model-table{width:100%;border-collapse:collapse;font-size:13px}
.model-table th{text-align:left;color:var(--text2);padding:6px 8px;border-bottom:1px solid var(--border)}
.model-table td{padding:6px 8px;border-bottom:1px solid var(--border)}
@media(max-width:600px){body{padding:12px}.grid{grid-template-columns:1fr}}
</style></head><body>
<a class="back" href="/" data-i18n="back">‚Üê Back to Chat</a>
<h1>üòà <span data-i18n="title">SalmAlm Dashboard</span></h1>

<div class="grid" id="stats-grid">
  <div class="card"><h3 data-i18n="h-cost">üí∞ Total Cost</h3><div class="big-num" id="total-cost">$0.00</div></div>
  <div class="card"><h3 data-i18n="h-sessions">üí¨ Sessions</h3><div class="big-num" id="total-sessions">0</div></div>
  <div class="card"><h3 data-i18n="h-tools">üîß Tool Calls (24h)</h3><div class="big-num" id="total-tools">0</div></div>
  <div class="card"><h3 data-i18n="h-status">üì° Status</h3><div class="big-num" style="font-size:20px" id="status-text" data-i18n="loading">Loading...</div></div>
</div>

<div class="grid">
  <div class="card">
    <h3 data-i18n="h-tool-usage">üìä Tool Usage (24h)</h3>
    <div class="chart-wrap"><canvas id="toolChart"></canvas></div>
  </div>
  <div class="card">
    <h3 data-i18n="h-cost-model">üí∏ Cost by Model</h3>
    <div class="chart-wrap"><canvas id="costChart"></canvas></div>
  </div>
</div>

<div class="card" style="margin-bottom:16px">
  <h3 data-i18n="h-model-usage">üß† Model Usage</h3>
  <table class="model-table">
    <thead><tr><th data-i18n="th-model">Model</th><th data-i18n="th-calls">Calls</th><th data-i18n="th-in">Tokens In</th><th data-i18n="th-out">Tokens Out</th><th data-i18n="th-cost">Cost</th></tr></thead>
    <tbody id="model-tbody"></tbody>
  </table>
</div>

<div class="card" style="margin-bottom:16px">
  <h3><span data-i18n="h-audit">üìã Audit Log</span>
    <select id="audit-filter" style="float:right;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:12px">
      <option value="">All</option>
      <option value="tool_call">tool_call</option>
      <option value="api_call">api_call</option>
      <option value="auth_success">auth_success</option>
      <option value="auth_failure">auth_failure</option>
      <option value="cost_alert">cost_alert</option>
      <option value="session_create">session_create</option>
      <option value="session_delete">session_delete</option>
    </select>
  </h3>
  <table class="model-table" style="margin-top:8px">
    <thead><tr><th data-i18n="th-time">Time</th><th data-i18n="th-type">Type</th><th data-i18n="th-session">Session</th><th data-i18n="th-detail">Detail</th></tr></thead>
    <tbody id="audit-tbody"><tr><td colspan="4" style="color:var(--text2)">Loading...</td></tr></tbody>
  </table>
</div>

<div class="grid">
  <div class="card">
    <h3 data-i18n="h-cron">‚è∞ Cron Jobs</h3>
    <div id="cron-list" style="font-size:13px">None</div>
  </div>
  <div class="card">
    <h3 data-i18n="h-plugins">üß© Plugins</h3>
    <div id="plugin-list" style="font-size:13px">None</div>
  </div>
</div>

<script>
const _i18n={
  en:{
    'back':'‚Üê Back to Chat','title':'SalmAlm Dashboard',
    'h-cost':'üí∞ Total Cost','h-sessions':'üí¨ Sessions','h-tools':'üîß Tool Calls (24h)','h-status':'üì° Status',
    'loading':'Loading...','h-tool-usage':'üìä Tool Usage (24h)','h-cost-model':'üí∏ Cost by Model',
    'h-model-usage':'üß† Model Usage','h-audit':'üìã Audit Log',
    'th-model':'Model','th-calls':'Calls','th-in':'Tokens In','th-out':'Tokens Out','th-cost':'Cost',
    'th-time':'Time','th-type':'Type','th-session':'Session','th-detail':'Detail',
    'h-cron':'‚è∞ Cron Jobs','h-plugins':'üß© Plugins','no-entries':'No entries'
  },
  ko:{
    'back':'‚Üê Ï±ÑÌåÖÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞','title':'ÏÇ∂Ïïé ÎåÄÏãúÎ≥¥Îìú',
    'h-cost':'üí∞ Ï¥ù ÎπÑÏö©','h-sessions':'üí¨ ÏÑ∏ÏÖò','h-tools':'üîß ÎèÑÍµ¨ Ìò∏Ï∂ú (24ÏãúÍ∞Ñ)','h-status':'üì° ÏÉÅÌÉú',
    'loading':'Î∂àÎü¨Ïò§Îäî Ï§ë...','h-tool-usage':'üìä ÎèÑÍµ¨ ÏÇ¨Ïö©Îüâ (24ÏãúÍ∞Ñ)','h-cost-model':'üí∏ Î™®Îç∏Î≥Ñ ÎπÑÏö©',
    'h-model-usage':'üß† Î™®Îç∏ ÏÇ¨Ïö©Îüâ','h-audit':'üìã Í∞êÏÇ¨ Î°úÍ∑∏',
    'th-model':'Î™®Îç∏','th-calls':'Ìò∏Ï∂ú','th-in':'ÏûÖÎ†• ÌÜ†ÌÅ∞','th-out':'Ï∂úÎ†• ÌÜ†ÌÅ∞','th-cost':'ÎπÑÏö©',
    'th-time':'ÏãúÍ∞Ñ','th-type':'Ïú†Ìòï','th-session':'ÏÑ∏ÏÖò','th-detail':'ÏÉÅÏÑ∏',
    'h-cron':'‚è∞ ÌÅ¨Î°† ÏûëÏóÖ','h-plugins':'üß© ÌîåÎü¨Í∑∏Ïù∏','no-entries':'Ìï≠Î™© ÏóÜÏùå'
  }
};
const _lang=localStorage.getItem('salmalm-lang')||'en';
function t(k){return (_i18n[_lang]||_i18n.en)[k]||(_i18n.en[k]||k)}
document.querySelectorAll('[data-i18n]').forEach(function(el){el.textContent=t(el.getAttribute('data-i18n'))});

const tok=sessionStorage.getItem('tok')||'';
const hdr={'X-Session-Token':tok};

async function load(){
  try{
    const [dashRes,sessRes]=await Promise.all([
      fetch('/api/dashboard',{headers:hdr}),
      fetch('/api/sessions',{headers:hdr})
    ]);
    const dash=await dashRes.json();
    const sess=await sessRes.json();

    /* Stats */
    const u=dash.usage||{};
    document.getElementById('total-cost').textContent='$'+(u.total_cost||0).toFixed(4);
    document.getElementById('total-sessions').textContent=(sess.sessions||[]).length;
    const toolTotal=(dash.cost_timeline||[]).reduce((a,b)=>a+b.count,0);
    document.getElementById('total-tools').textContent=toolTotal;

    const statParts=[];
    statParts.push('<span class="badge badge-green">Engine OK</span>');
    if(dash.cron_jobs&&dash.cron_jobs.length)statParts.push('<span class="badge badge-yellow">'+dash.cron_jobs.length+' crons</span>');
    if(dash.plugins&&dash.plugins.length)statParts.push('<span class="badge badge-green">'+dash.plugins.length+' plugins</span>');
    if(dash.subagents&&dash.subagents.length)statParts.push('<span class="badge badge-yellow">'+dash.subagents.length+' agents</span>');
    document.getElementById('status-text').innerHTML=statParts.join(' ');

    /* Tool chart */
    const timeline=dash.cost_timeline||[];
    if(timeline.length){
      const labels=timeline.map(t=>t.hour.slice(-5)).reverse();
      const data=timeline.map(t=>t.count).reverse();
      new Chart(document.getElementById('toolChart'),{
        type:'bar',
        data:{labels,datasets:[{label:'Tool calls',data,backgroundColor:'#6366f1',borderRadius:4}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:'#94a3b8',font:{size:10}},grid:{display:false}},
                  y:{ticks:{color:'#94a3b8'},grid:{color:'#334155'}}}}
      });
    }

    /* Cost by model chart */
    const models=u.by_model||{};
    const mNames=Object.keys(models);
    if(mNames.length){
      const costs=mNames.map(m=>models[m].cost||0);
      const colors=['#6366f1','#22c55e','#eab308','#ef4444','#06b6d4','#f97316','#ec4899','#8b5cf6'];
      new Chart(document.getElementById('costChart'),{
        type:'doughnut',
        data:{labels:mNames.map(m=>m.split('/').pop()),datasets:[{data:costs,backgroundColor:colors.slice(0,mNames.length)}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#e2e8f0',font:{size:11}}}}}
      });

      /* Model table */
      let html='';
      mNames.sort((a,b)=>(models[b].cost||0)-(models[a].cost||0));
      mNames.forEach(m=>{
        const d=models[m];
        html+='<tr><td>'+m.split('/').pop()+'</td><td>'+(d.calls||0)+'</td><td>'+(d.input_tokens||0).toLocaleString()+'</td><td>'+(d.output_tokens||0).toLocaleString()+'</td><td>$'+(d.cost||0).toFixed(4)+'</td></tr>';
      });
      document.getElementById('model-tbody').innerHTML=html;
    }

    /* Cron */
    if(dash.cron_jobs&&dash.cron_jobs.length){
      document.getElementById('cron-list').innerHTML=dash.cron_jobs.map(j=>'<div class="stat-row"><span>'+j.name+'</span><span class="badge badge-'+(j.enabled?'green':'red')+'">'+(j.enabled?'ON':'OFF')+'</span></div>').join('');
    }

    /* Plugins */
    if(dash.plugins&&dash.plugins.length){
      document.getElementById('plugin-list').innerHTML=dash.plugins.map(p=>'<div class="stat-row"><span>'+p.name+'</span><span>'+p.tools+' tools</span></div>').join('');
    }
  }catch(e){console.error(e)}
}
load();
setInterval(load,60000);

/* Audit Log */
async function loadAudit(){
  const filter=document.getElementById('audit-filter').value;
  const url='/api/audit?limit=50'+(filter?'&type='+filter:'');
  try{
    const res=await fetch(url,{headers:hdr});
    const data=await res.json();
    const tbody=document.getElementById('audit-tbody');
    if(!data.entries||!data.entries.length){
      tbody.innerHTML='<tr><td colspan="4" style="color:var(--text2)">No entries</td></tr>';
      return;
    }
    tbody.innerHTML=data.entries.map(e=>{
      const ts=(e.timestamp||'').replace('T',' ').slice(0,19);
      const det=typeof e.detail==='object'?JSON.stringify(e.detail).slice(0,120):String(e.detail).slice(0,120);
      const typeColor={'tool_call':'#6366f1','api_call':'#22c55e','auth_success':'#22c55e','auth_failure':'#ef4444','cost_alert':'#eab308'}[e.event_type]||'var(--text2)';
      return '<tr><td style="white-space:nowrap">'+ts+'</td><td><span style="color:'+typeColor+'">'+e.event_type+'</span></td><td>'+(e.session_id||'-')+'</td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+det+'</td></tr>';
    }).join('');
  }catch(e){console.error(e)}
}
loadAudit();
document.getElementById('audit-filter').addEventListener('change',loadAudit);
setInterval(loadAudit,30000);
</script></body></html>