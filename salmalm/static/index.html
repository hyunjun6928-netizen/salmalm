<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SalmAlm â€” Personal AI Gateway</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#6366f1">
<link rel="icon" href="/icon-192.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/icon-192.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0d14;--bg2:#12141f;--bg3:#1a1d2b;--border:#252838;--text:#d4d4dc;--text2:#8889a0;
--accent:#7c5cfc;--accent2:#9b7dff;--accent-dim:rgba(124,92,252,0.12);--green:#34d399;--red:#f87171;
--user-bg:linear-gradient(135deg,#6d5cfc,#8b5cf6);--bot-bg:#161928;--yellow:#fbbf24;--blue:#60a5fa}
[data-theme="light"]{--bg:#f8f9fc;--bg2:#ffffff;--bg3:#f0f1f5;--border:#e2e4ea;--text:#1e293b;--text2:#64748b;
--accent:#6d5cfc;--accent2:#7c5cfc;--accent-dim:rgba(109,92,252,0.08);--green:#059669;--red:#dc2626;
--user-bg:linear-gradient(135deg,#6d5cfc,#8b5cf6);--bot-bg:#f7f7fb;--yellow:#d97706;--blue:#2563eb}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
body{display:grid;grid-template-rows:auto 1fr auto;grid-template-columns:260px 1fr;grid-template-areas:"side head" "side chat" "side input"}

/* SIDEBAR */
#sidebar{grid-area:side;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:0}
.side-header{padding:20px;border-bottom:1px solid var(--border)}
.side-header h1{font-size:20px;font-weight:600;display:flex;align-items:center;gap:8px}
.side-header h1 .icon{font-size:24px}
.side-header .tagline{font-size:11px;color:var(--text2);margin-top:4px;letter-spacing:0.5px;text-transform:uppercase}
.side-nav{flex:1;padding:12px;overflow-y:auto}
.nav-section{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;padding:12px 8px 6px;font-weight:600}
.nav-item{padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--text2);display:flex;align-items:center;gap:10px;transition:all 0.15s}
.session-item{padding:7px 10px;font-size:12px;gap:4px}.session-item:hover .session-del{opacity:0.8}
.nav-item:hover{background:var(--accent-dim);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent2);font-weight:500}
.nav-item .badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600}
.side-footer{padding:16px;border-top:1px solid var(--border);font-size:11px;color:var(--text2)}
.side-footer .status{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.side-footer .dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block}

/* HEADER */
#header{grid-area:head;padding:14px 24px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px}
#header .title{font-size:15px;font-weight:500}
#header .model-badge{font-size:11px;padding:4px 10px;border-radius:6px;background:var(--accent-dim);color:var(--accent2);font-weight:500}
#header .spacer{flex:1}
#header .cost{font-size:12px;color:var(--text2)}
#header .cost b{color:var(--green);font-weight:600}
#new-chat-btn{background:var(--accent-dim);color:var(--accent2);border:none;padding:6px 14px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:500;transition:all 0.15s}
#new-chat-btn:hover{background:var(--accent);color:#fff}

/* CHAT */
#chat{grid-area:chat;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth}
#chat::-webkit-scrollbar{width:6px}
#chat::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.msg-row{display:flex;gap:12px;max-width:90%;animation:fadeIn 0.2s ease}
.msg-row.user{align-self:flex-end;flex-direction:row-reverse}
.msg-row.assistant{align-self:flex-start}
.avatar{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.msg-row.user .avatar{background:var(--user-bg)}
.msg-row.assistant .avatar{background:var(--bg3);border:1px solid var(--border)}
.bubble{padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.7;white-space:pre-wrap;word-break:break-word}
.msg-row.user .bubble{background:var(--user-bg);color:#fff;border-bottom-right-radius:4px}
.msg-row.assistant .bubble{background:var(--bot-bg);border:1px solid var(--border);border-bottom-left-radius:4px}
.bubble code{background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:4px;font-size:13px;font-family:'SF Mono',monospace}
.bubble pre{background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;overflow-x:auto;margin:8px 0;font-size:13px;border:1px solid var(--border)}
.bubble pre code{background:none;padding:0;font-size:13px}
/* Syntax highlight keywords */
.bubble pre .kw{color:#c792ea}.bubble pre .str{color:#c3e88d}.bubble pre .num{color:#f78c6c}.bubble pre .cmt{color:#546e7a;font-style:italic}
/* Drag highlight */
.input-area.drag-over{border:2px dashed var(--accent);background:var(--accent-dim);transition:all 0.2s}
/* Scroll to bottom button */
#scroll-bottom{position:fixed;bottom:100px;right:24px;width:40px;height:40px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-size:18px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:50;transition:opacity 0.2s}
#scroll-bottom:hover{background:var(--accent-dim);color:var(--accent2)}
/* Message actions */
.msg-actions{opacity:0;transition:opacity 0.15s;display:inline-flex;gap:4px;margin-left:8px}
.msg-row:hover .msg-actions{opacity:1}
.msg-actions span{cursor:pointer;font-size:12px;padding:2px 4px;border-radius:4px}
.msg-actions span:hover{background:var(--accent-dim)}
.bubble pre code{background:none;padding:0}
.meta{font-size:11px;color:var(--text2);margin-top:4px;display:flex;gap:8px;align-items:center}
.msg-row.user .meta{justify-content:flex-end}
.typing-indicator{display:flex;gap:4px;padding:8px 0}
.typing-indicator span{width:7px;height:7px;border-radius:50%;background:var(--text2);animation:bounce 1.4s infinite ease-in-out}
.typing-indicator span:nth-child(2){animation-delay:0.2s}
.typing-indicator span:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,80%,100%{transform:scale(0.6)}40%{transform:scale(1)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* INPUT */
#input-area{grid-area:input;padding:16px 24px;background:var(--bg2);border-top:1px solid var(--border)}
.input-box{display:flex;gap:8px;align-items:flex-end;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:8px 12px;transition:border-color 0.2s}
.input-box:focus-within{border-color:var(--accent)}
#input{flex:1;padding:6px 0;border:none;background:transparent;color:var(--text);font-size:14px;font-family:inherit;outline:none;resize:none;max-height:150px;line-height:1.5}
#send-btn{width:36px;height:36px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0}
#send-btn:hover{background:var(--accent2);transform:scale(1.05)}
#send-btn:disabled{opacity:0.3;cursor:not-allowed;transform:none}
#send-btn svg{width:18px;height:18px}
.input-hint{font-size:11px;color:var(--text2);margin-top:6px;text-align:center}

/* SETTINGS PANEL */
#settings{display:none;grid-area:chat;overflow-y:auto;padding:24px}
.settings-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.settings-card h3{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--accent2)}
.settings-card label{font-size:12px;color:var(--text2);display:block;margin-bottom:4px}
.settings-card input,.settings-card select{width:100%;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;margin-bottom:12px}
.settings-card .btn{padding:8px 16px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-size:13px}
.settings-tab.active{color:var(--accent2)!important;border-bottom-color:var(--accent)!important}
.feat-cat{margin-bottom:12px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--bg2)}
.feat-cat-header{display:flex;align-items:center;gap:8px;padding:14px 16px;cursor:pointer;font-weight:600;font-size:14px;user-select:none}
.feat-cat-header:hover{background:var(--bg3)}
.feat-cat-header .arrow{transition:transform .2s;font-size:10px}
.feat-cat.open .arrow{transform:rotate(90deg)}
.feat-cat-body{display:none;padding:8px 16px 16px}
.feat-cat.open .feat-cat-body{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.feat-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 14px;font-size:13px}
.feat-card .feat-name{font-weight:600;margin-bottom:4px}
.feat-card .feat-desc{color:var(--text2);font-size:12px;margin-bottom:6px}
.feat-card .feat-cmd{display:inline-block;background:var(--accent-dim,rgba(59,130,246,0.15));color:var(--accent2);padding:2px 8px;border-radius:6px;font-size:11px;font-family:monospace;cursor:pointer;border:none}
.feat-card .feat-cmd:hover{background:var(--accent);color:#fff}
@media(max-width:600px){.feat-cat.open .feat-cat-body{grid-template-columns:1fr}}

/* TOOL CALL DISPLAY */
.tool-call{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;margin:6px 0;font-size:12px;font-family:'SF Mono',monospace}
.tool-call .tool-name{color:var(--accent2);font-weight:600}
.tool-call .tool-result{color:var(--text2);margin-top:4px;max-height:120px;overflow-y:auto}

/* COPY BUTTON */
.copy-btn{position:absolute;top:6px;right:6px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:3px 8px;border-radius:4px;font-size:10px;cursor:pointer;opacity:0;transition:opacity 0.15s}
.bubble:hover .copy-btn{opacity:1}
.bubble{position:relative}
.bubble pre{position:relative}

/* STATS BAR */
#stats-bar{display:flex;gap:16px;padding:6px 12px;background:var(--bg);border-radius:8px;margin-top:8px;font-size:11px;color:var(--text2)}
#stats-bar .stat{display:flex;align-items:center;gap:4px}
#stats-bar .stat-val{color:var(--accent2);font-weight:600}

/* THEME TOGGLE */
#theme-toggle{background:none;border:1px solid var(--border);color:var(--text2);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:14px;transition:all 0.15s}
#theme-toggle:hover{border-color:var(--accent);color:var(--text)}

/* MOBILE MENU BUTTON */
#mobile-menu-btn{display:none;background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:4px}

/* SEARCH MODAL */
#search-modal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,0.6);align-items:flex-start;justify-content:center;padding-top:15vh}
#search-modal.open{display:flex}
#search-box{background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:560px;max-width:90vw;max-height:60vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.4)}
#search-input{padding:16px 20px;border:none;background:transparent;color:var(--text);font-size:15px;outline:none;border-bottom:1px solid var(--border)}
#search-input::placeholder{color:var(--text2)}
#search-results{overflow-y:auto;padding:8px;flex:1}
.search-item{padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px;line-height:1.5;transition:background 0.1s}
.search-item:hover{background:var(--accent-dim)}
.search-item .sr-session{font-size:11px;color:var(--text2)}
.search-item .sr-snippet{color:var(--text)}
.search-item mark{background:var(--accent-dim);color:var(--accent2);padding:1px 2px;border-radius:2px}
#search-hint{padding:12px 16px;font-size:11px;color:var(--text2);text-align:center;border-top:1px solid var(--border)}

/* MODEL BADGE ON BUBBLES */
.model-tag{display:inline-block;font-size:10px;padding:2px 6px;border-radius:4px;background:var(--accent-dim);color:var(--accent2);margin-right:4px;font-weight:500}
/* TTS BUTTON */
.tts-btn{background:none;border:none;cursor:pointer;font-size:14px;opacity:0.5;transition:opacity 0.15s;padding:2px 4px}
.tts-btn:hover{opacity:1}

/* MESSAGE EDIT/DELETE ACTIONS */
.msg-edit-actions{opacity:0;transition:opacity 0.15s;display:inline-flex;gap:2px;margin-left:4px}
.msg-row.user:hover .msg-edit-actions{opacity:1}
.msg-edit-actions button{background:none;border:none;cursor:pointer;font-size:13px;padding:2px 4px;border-radius:4px;opacity:0.6;transition:opacity 0.15s}
.msg-edit-actions button:hover{opacity:1;background:var(--accent-dim)}
.edit-textarea{width:100%;min-height:60px;padding:10px 12px;border-radius:10px;border:1px solid var(--accent);background:var(--bg);color:var(--text);font-size:14px;font-family:inherit;resize:vertical;outline:none;line-height:1.5}
.edit-textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 2px var(--accent-dim)}
.edit-bar{display:flex;gap:6px;margin-top:6px;font-size:12px}
.edit-bar button{padding:4px 12px;border-radius:6px;border:none;cursor:pointer;font-size:12px}
.edit-bar .save-btn{background:var(--accent);color:#fff}
.edit-bar .cancel-btn{background:var(--bg3);color:var(--text2)}
/* EXPORT DROPDOWN */
.export-dropdown{position:relative;display:inline-block}
.export-menu{display:none;position:absolute;top:100%;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:4px;min-width:150px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.3);margin-top:4px}
.export-menu.open{display:block}
.export-menu button{display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;color:var(--text);font-size:13px;cursor:pointer;border-radius:6px}
.export-menu button:hover{background:var(--accent-dim);color:var(--accent2)}
/* COMMAND PALETTE */
#cmd-palette{position:fixed;top:15vh;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:520px;max-width:92vw;max-height:60vh;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.5);z-index:10001;display:none}
#cmd-palette.open{display:flex}
#cmd-input{padding:14px 18px;border:none;background:transparent;color:var(--text);font-size:15px;outline:none;border-bottom:1px solid var(--border)}
#cmd-input::placeholder{color:var(--text2)}
#cmd-results{overflow-y:auto;padding:6px;flex:1;max-height:50vh}
.cmd-item{padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:10px;transition:background 0.1s}
.cmd-item:hover,.cmd-item.selected{background:var(--accent-dim);color:var(--accent2)}
.cmd-item .cmd-icon{font-size:16px;width:24px;text-align:center}
.cmd-item .cmd-label{flex:1}
.cmd-item .cmd-shortcut{font-size:11px;color:var(--text2)}
#cmd-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:10000}
#cmd-overlay.open{display:block}
/* PWA INSTALL BANNER */
#pwa-install{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--accent);border-radius:12px;padding:12px 20px;z-index:500;box-shadow:0 8px 24px rgba(0,0,0,0.3);font-size:13px;align-items:center;gap:12px;display:none}
#pwa-install.show{display:flex}
#pwa-install button{padding:6px 14px;border-radius:8px;border:none;cursor:pointer;font-size:12px}
#pwa-install .install-btn{background:var(--accent);color:#fff}
#pwa-install .dismiss-btn{background:var(--bg3);color:var(--text2)}
/* MOBILE */
@media(max-width:768px){
  body{grid-template-columns:1fr;grid-template-areas:"head" "chat" "input"}
  #sidebar{display:none;position:fixed;top:0;left:0;width:280px;height:100%;z-index:1000;box-shadow:4px 0 24px rgba(0,0,0,0.4)}
  #sidebar.open{display:flex}
  #mobile-menu-btn{display:block}
  .msg-row{max-width:95%}
  #chat{padding:12px}
  #input-area{padding:10px 12px}
  .input-hint{display:none}
  #header{padding:10px 12px}
  .side-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999}
  .side-overlay.open{display:block}
  .nav-item{min-height:44px;padding:12px}
  .session-item{min-height:40px}
  #send-btn{width:44px;height:44px}
  #input{font-size:16px}
  #cmd-palette{width:100%;max-width:100%;top:0;left:0;transform:none;border-radius:0;max-height:100vh;height:100vh}
  #search-box{width:100%;max-width:100%;border-radius:0;max-height:100vh}
  #search-modal.open{padding-top:0}
  .msg-edit-actions{opacity:1}
  .bubble pre{max-width:calc(100vw - 80px);overflow-x:auto;-webkit-overflow-scrolling:touch}
  #filter-modal{width:100%;max-width:100%;left:0;transform:none;border-radius:0;top:0;height:100vh;max-height:100vh}
  input,textarea,select{font-size:16px!important}
}
</style></head><body>

<div id="sidebar">
  <div class="side-header">
    <h1><span class="icon">ğŸ˜ˆ</span> SalmAlm</h1>
    <div class="tagline">Personal AI Gateway</div>
  </div>
  <div class="side-nav">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 16px 4px">
      <div class="nav-section" style="margin:0;padding:0;cursor:pointer" data-action="showChat" data-i18n="sec-chats">ğŸ’¬ Chats</div>
      <button data-action="newSession" title="New Chat" style="background:var(--accent);color:#fff;border:none;width:28px;height:28px;border-radius:8px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center">+</button>
    </div>
    <div id="session-list" style="max-height:240px;overflow-y:auto;padding:0 8px 4px"></div>
    <div class="nav-section" style="border-top:1px solid var(--border);margin-top:4px;padding-top:8px">ğŸ“¡ Channels</div>
    <div class="nav-item" id="tg-status">ğŸ“¡ Telegram <span class="badge">ON</span></div>
    <div class="nav-section" data-action="toggleTools" style="cursor:pointer">ğŸ› ï¸ Tools (32) â–¾</div>
    <div id="tools-list" style="display:none">
    <div class="nav-item" data-action="qc-help">ğŸ”§ exec Â· file Â· search</div>
    <div class="nav-item" data-action="qc-sysmon">ğŸ–¥ï¸ System Monitor</div>
    <div class="nav-item" data-action="qc-memory">ğŸ§  Memory</div>
    <div class="nav-item" data-action="qc-cost">ğŸ’° Cost Tracker</div>
    <div class="nav-item" data-action="qc-cron">â° Cron Manager</div>
    <div class="nav-item" data-action="qc-python">ğŸ Python Exec</div>
    <div class="nav-item" data-action="qc-image">ğŸ¨ Image Gen</div>
    <div class="nav-item" data-action="qc-tts">ğŸ”Š TTS</div>
    </div>
    <div class="nav-section" data-i18n="sec-admin">Admin</div>
    <div class="nav-item" data-action="showSettings"data-i18n="nav-settings">âš™ï¸ Settings</div>
    <div class="nav-item" data-action="showUsage">ğŸ“Š Usage</div>
    <div class="nav-item" data-action="showDashboard">ğŸ“ˆ Dashboard</div>
  </div>
  <div class="side-footer">
    <div class="status"><span class="dot"></span> Running</div>
    <div>{{VERSION}} Â· AES-256-GCM</div>
  </div>
</div>

<div class="side-overlay" id="side-overlay" data-action="toggleSidebar"></div>

<div id="header">
  <button id="mobile-menu-btn" data-action="toggleSidebar">â˜°</button>
  <div class="title">ğŸ’¬ Web Chat</div>
  <div class="model-badge" id="model-badge">auto routing</div>
  <div class="spacer"></div>
  <div class="cost">Cost: <b id="cost-display">$0.0000</b></div>
  <button id="theme-toggle" data-action="toggleTheme" title="Toggle theme">ğŸŒ™</button>
  <div class="export-dropdown"><button id="export-btn" data-action="toggleExportMenu" title="Export chat" style="background:var(--accent-dim);color:var(--accent2);border:none;padding:6px 14px;border-radius:8px;font-size:12px;cursor:pointer"data-i18n="btn-export">ğŸ“¥ Export</button><div id="export-menu" class="export-menu"><button data-action="exportMd">ğŸ“ Markdown</button><button data-action="exportJson">ğŸ“‹ JSON</button><button data-action="exportServerMd">ğŸ“¥ Download MD</button><button data-action="exportServerJson">ğŸ“¥ Download JSON</button></div></div>
  <button id="new-chat-btn" data-action="newSession" title="New Chat">âœ¨ New</button>
</div>

<div id="update-banner" style="display:none;background:linear-gradient(135deg,#1e3a5f,#2d1b69);border:1px solid #3b82f6;border-radius:12px;padding:12px 16px;margin:8px 16px;display:none;align-items:center;justify-content:space-between;font-size:13px">
  <span>â¬†ï¸ <b>Update Available</b> â€” <span id="banner-ver"></span></span>
  <button onclick="window.doUpdate()" style="background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:6px 16px;cursor:pointer;font-size:12px">Update Now</button>
</div>
<div id="chat"></div>

<div id="settings">
  <div style="display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:16px;position:sticky;top:0;background:var(--bg);z-index:10;padding-top:8px">
    <button class="settings-tab active" data-settings-tab="general" style="padding:10px 20px;border:none;background:none;color:var(--text);cursor:pointer;font-size:14px;font-weight:600;border-bottom:2px solid transparent;margin-bottom:-2px" data-i18n="tab-general">âš™ï¸ General</button>
    <button class="settings-tab" data-settings-tab="features" style="padding:10px 20px;border:none;background:none;color:var(--text2);cursor:pointer;font-size:14px;font-weight:600;border-bottom:2px solid transparent;margin-bottom:-2px" data-i18n="tab-features">ğŸ“– Features</button>
  </div>
  <div id="settings-general">
  <div class="settings-card">
    <h3 data-i18n="h-lang">ğŸŒ Language</h3>
    <select id="s-lang" data-action="setLang" style="width:200px">
      <option value="en">English</option>
      <option value="ko">í•œêµ­ì–´</option>
    </select>
  </div>
  <div class="settings-card">
    <h3 data-i18n="h-model">ğŸ¤– Model Settings</h3>
    <labeldata-i18n="lbl-model">Default Model</label>
    <select id="s-model" data-action="setModel">
      <optgroup label="ğŸ”„ Auto">
        <option value="auto">Auto Routing (Recommended)</option>
      </optgroup>
      <optgroup label="ğŸŸ£ Anthropic">
        <option value="anthropic/claude-opus-4-6">Claude Opus 4.6 ğŸ’</option>
        <option value="anthropic/claude-sonnet-4-20250514">Claude Sonnet 4</option>
        <option value="anthropic/claude-haiku-3.5-20241022">Claude Haiku 3.5 âš¡</option>
      </optgroup>
      <optgroup label="ğŸŸ¢ OpenAI">
        <option value="openai/gpt-5.3-codex">GPT-5.3 Codex</option>
        <option value="openai/gpt-5.1-codex">GPT-5.1 Codex</option>
        <option value="openai/gpt-4.1">GPT-4.1</option>
        <option value="openai/gpt-4.1-mini">GPT-4.1 Mini âš¡</option>
        <option value="openai/gpt-4.1-nano">GPT-4.1 Nano ğŸ’¨</option>
        <option value="openai/o3">o3 ğŸ§ </option>
        <option value="openai/o3-mini">o3-mini</option>
        <option value="openai/o4-mini">o4-mini</option>
      </optgroup>
      <optgroup label="ğŸ”µ xAI">
        <option value="xai/grok-4">Grok 4</option>
        <option value="xai/grok-3">Grok 3</option>
        <option value="xai/grok-3-mini">Grok 3 Mini âš¡</option>
      </optgroup>
      <optgroup label="ğŸŸ¡ Google">
        <option value="google/gemini-3-pro-preview">Gemini 3 Pro</option>
        <option value="google/gemini-3-flash-preview">Gemini 3 Flash âš¡</option>
      </optgroup>
      <optgroup label="ğŸ”· OpenRouter">
        <option value="deepseek/deepseek-r1">DeepSeek R1 ğŸ§ </option>
        <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
        <option value="meta-llama/llama-4-maverick">Llama 4 Maverick</option>
        <option value="meta-llama/llama-4-scout">Llama 4 Scout âš¡</option>
      </optgroup>
      <optgroup label="ğŸ¦™ Ollama (Local)">
        <option value="ollama/llama3.3">Llama 3.3</option>
        <option value="ollama/qwen3">Qwen 3</option>
        <option value="ollama/gemma3">Gemma 3</option>
      </optgroup>
    </select>
    <label style="margin-top:8px"data-i18n="lbl-ollama">Ollama URL (Local LLM)</label>
    <input id="s-ollama-url" type="text" placeholder="http://localhost:11434/v1" style="width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px">
    <button data-action="saveOllama" style="margin-top:4px;padding:6px 12px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-size:12px"data-i18n="btn-save-ollama">Save Ollama URL</button>
    <h3 style="margin-top:20px" data-i18n="h-routing">ğŸ”€ Auto Routing Models</h3>
    <p style="font-size:12px;color:var(--text2);margin:4px 0 8px" data-i18n="routing-desc">When "Auto Routing" is selected, messages are classified by complexity and routed to these models:</p>
    <label style="font-size:12px" data-i18n="lbl-route-simple">âš¡ Simple (greetings, short questions)</label>
    <select id="route-simple" class="route-select" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;margin-bottom:8px"></select>
    <label style="font-size:12px" data-i18n="lbl-route-moderate">ğŸ”§ Moderate (code, analysis, summaries)</label>
    <select id="route-moderate" class="route-select" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;margin-bottom:8px"></select>
    <label style="font-size:12px" data-i18n="lbl-route-complex">ğŸ’ Complex (architecture, long reasoning)</label>
    <select id="route-complex" class="route-select" style="width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;margin-bottom:8px"></select>
    <button data-action="saveRouting" style="padding:6px 12px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-size:12px" data-i18n="btn-save-routing">Save Routing</button>
    <span id="route-status" style="font-size:11px;color:var(--text2);margin-left:8px"></span>
  </div>
  <div class="settings-card">
    <h3 data-i18n="h-keys">ğŸ”‘ API Key Management</h3>
    <labeldata-i18n="lbl-anthropic">Anthropic API Key</label>
    <div style="display:flex;gap:6px"><input id="sk-anthropic" type="password" placeholder="sk-ant-..."><button class="btn" data-action="save-anthropic">Save</button><button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="test-anthropic">Test</button></div>
    <labeldata-i18n="lbl-openai">OpenAI API Key</label>
    <div style="display:flex;gap:6px"><input id="sk-openai" type="password" placeholder="sk-..."><button class="btn" data-action="save-openai">Save</button><button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="test-openai">Test</button></div>
    <labeldata-i18n="lbl-xai">xAI API Key (Grok)</label>
    <div style="display:flex;gap:6px"><input id="sk-xai" type="password" placeholder="xai-..."><button class="btn" data-action="save-xai">Save</button><button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="test-xai">Test</button></div>
    <labeldata-i18n="lbl-google">Google API Key (Gemini)</label>
    <div style="display:flex;gap:6px"><input id="sk-google" type="password" placeholder="AIza..."><button class="btn" data-action="save-google">Save</button><button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="test-google">Test</button></div>
    <labeldata-i18n="lbl-brave">Brave Search API Key</label>
    <div style="display:flex;gap:6px"><input id="sk-brave" type="password" placeholder="BSA..."><button class="btn" data-action="save-brave">Save</button></div>
    <div id="key-test-result" style="margin-top:8px;font-size:12px"></div>
    <div id="vault-keys" style="margin-top:12px"></div>
  </div>
  <div class="settings-card" id="google-oauth-card">
    <h3 data-i18n="h-google-oauth">ğŸ”— Google Integration (Calendar & Gmail)</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">
      <span data-i18n="google-oauth-desc">OAuth2 integration is required for Google Calendar and Gmail features.</span><br>
      <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener" style="color:var(--accent2)">Google Cloud Console</a> â€” <span data-i18n="google-oauth-console">Create an OAuth 2.0 Client ID at Google Cloud Console.</span>
    </p>
    <label data-i18n="lbl-google-client-id">Google Client ID</label>
    <div style="display:flex;gap:6px"><input id="sk-google-client-id" type="password" placeholder="xxxx.apps.googleusercontent.com"><button class="btn" data-action="save-google-client-id">Save</button></div>
    <label data-i18n="lbl-google-client-secret">Google Client Secret</label>
    <div style="display:flex;gap:6px"><input id="sk-google-client-secret" type="password" placeholder="GOCSPX-..."><button class="btn" data-action="save-google-client-secret">Save</button></div>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button class="btn" data-action="googleConnect" id="google-connect-btn" data-i18n="btn-google-connect">ğŸ”— Connect Google Account</button>
      <button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="googleDisconnect" data-i18n="btn-google-disconnect">Disconnect</button>
      <span id="google-status" style="font-size:12px;color:var(--text2)"></span>
    </div>
    <div id="google-result" style="margin-top:8px;font-size:12px"></div>
    <details style="margin-top:12px">
      <summary style="font-size:12px;color:var(--text2);cursor:pointer" data-i18n="google-guide-title">ğŸ“‹ Setup Guide</summary>
      <ol style="font-size:12px;color:var(--text2);margin-top:8px;padding-left:20px;line-height:2">
        <li><a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener" style="color:var(--accent2)">Google Cloud Console</a> â€” <span data-i18n="google-guide-1">Google Cloud Console â†’ Create/Select Project</span></li>
        <li data-i18n="google-guide-2">APIs & Services â†’ Credentials â†’ Create OAuth 2.0 Client ID</li>
        <li data-i18n="google-guide-3">Application type: Web application</li>
        <li><span data-i18n="google-guide-4">Authorized redirect URI:</span> <code style="background:var(--bg);padding:2px 6px;border-radius:4px">http://localhost:PORT/api/google/callback</code></li>
        <li data-i18n="google-guide-5">Enter Client ID and Client Secret above</li>
        <li data-i18n="google-guide-6">Click Connect Google Account</li>
      </ol>
    </details>
  </div>
  <div class="settings-card" id="soul-card">
    <h3 data-i18n="h-soul">ğŸ“œ SOUL.md (Custom System Prompt)</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:8px;line-height:1.6">
      <span data-i18n="soul-desc">Set a custom system prompt. It will be prepended to all conversations.</span><br>
      <code style="font-size:11px" data-i18n="soul-path">~/.salmalm/SOUL.md Â· Leave empty to restore default</code>
    </p>
    <textarea id="soul-editor" style="width:100%;min-height:150px;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:'SF Mono',monospace;resize:vertical;line-height:1.6" placeholder="# My Custom Persona\n\nYou are ..."></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" data-action="saveSoul" data-i18n="btn-save-soul">ğŸ’¾ Save</button>
      <button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="resetSoul" data-i18n="btn-reset-soul">ğŸ”„ Reset</button>
    </div>
    <div id="soul-result" style="margin-top:6px;font-size:12px"></div>
  </div>
  <div class="settings-card" id="usage-card">
    <h3data-i18n="h-usage">ğŸ“Š Token Usage</h3>
    <div id="usage-detail"></div>
  </div>
  <div class="settings-card">
    <h3 data-i18n="h-password">ğŸ”’ ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸</h3>
    <div id="pw-section-change">
      <label data-i18n="pw-current">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="pw-old" data-i18n-ph="pw-current" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
      <label data-i18n="pw-new">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="pw-new" data-i18n-ph="pw-new-hint" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ, ë¹„ìš°ë©´ í•´ì œ)">
      <label data-i18n="pw-confirm">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
      <input type="password" id="pw-confirm" data-i18n-ph="pw-confirm-hint" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥">
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn" data-action="changePw" data-i18n="pw-change">ë³€ê²½</button>
        <button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="removePw" data-i18n="pw-remove">ë¹„ë°€ë²ˆí˜¸ í•´ì œ</button>
      </div>
    </div>
    <div id="pw-section-set" style="display:none">
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px" data-i18n="pw-not-set">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <label data-i18n="pw-new">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="pw-set-new" data-i18n-ph="pw-min4" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)">
      <label data-i18n="pw-confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
      <input type="password" id="pw-set-confirm" data-i18n-ph="pw-reenter" placeholder="ë‹¤ì‹œ ì…ë ¥">
      <button class="btn" data-action="setPw" data-i18n="pw-set">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</button>
    </div>
    <div id="pw-result" style="margin-top:8px;font-size:12px"></div>
  </div>
  <div class="settings-card" id="users-card">
    <h3>ğŸ‘¥ Users / ì‚¬ìš©ì ê´€ë¦¬</h3>
    <div id="users-panel">
      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
        <label style="font-size:13px;margin:0"><input type="checkbox" id="mt-toggle"> Multi-tenant / ë©€í‹°í…Œë„ŒíŠ¸</label>
        <select id="reg-mode" style="width:auto;margin:0;padding:4px 8px">
          <option value="admin_only">Admin-only registration</option>
          <option value="open">Open registration</option>
        </select>
      </div>
      <div id="user-list" style="font-size:13px;color:var(--text2);margin-bottom:12px">Loading...</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="new-user-name" placeholder="Username" style="width:120px;margin:0">
        <input id="new-user-pw" type="password" placeholder="Password" style="width:120px;margin:0">
        <select id="new-user-role" style="width:auto;margin:0;padding:4px 8px">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button class="btn" data-action="createUser">+ Create</button>
      </div>
    </div>
  </div>
  <div class="settings-card" id="migration-card">
    <h3>ğŸ“¦ Agent Migration / ì—ì´ì „íŠ¸ ì´ë™</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:12px">Export or import your agent's personality, memory, settings, and data.<br>ì—ì´ì „íŠ¸ì˜ ì¸ê²©, ê¸°ì–µ, ì„¤ì •, ë°ì´í„°ë¥¼ ë‚´ë³´ë‚´ê±°ë‚˜ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
    <div style="margin-bottom:12px">
      <strong style="font-size:12px;color:var(--text)">Export / ë‚´ë³´ë‚´ê¸°</strong>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin:8px 0">
        <label style="font-size:11px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="exp-sessions" checked> Sessions</label>
        <label style="font-size:11px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="exp-data" checked> Data (notes/expenses)</label>
        <label style="font-size:11px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="exp-vault"> Vault (API keys)</label>
      </div>
      <button class="btn" data-action="exportAgent" style="font-size:12px">ğŸ“¥ Export Agent</button>
      <button class="btn" data-action="quickSyncExport" style="background:var(--bg3);color:var(--text2);font-size:12px;margin-left:4px">âš¡ Quick Sync</button>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:12px">
      <strong style="font-size:12px;color:var(--text)">Import / ê°€ì ¸ì˜¤ê¸°</strong>
      <div id="import-dropzone" style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;margin:8px 0;cursor:pointer;transition:border-color 0.2s" onclick="document.getElementById('import-file-input').click()">
        <p style="font-size:13px;color:var(--text2);margin:0">ğŸ“‚ Drop ZIP file here or click to browse<br>ZIP íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
        <input type="file" id="import-file-input" accept=".zip" style="display:none">
      </div>
      <div id="import-preview" style="display:none;font-size:12px;color:var(--text2);margin:8px 0;padding:8px;background:var(--bg);border-radius:6px"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="import-mode" style="padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px">
          <option value="overwrite">Overwrite / ë®ì–´ì“°ê¸°</option>
          <option value="merge">Merge / ë³‘í•©</option>
          <option value="skip">Skip existing / ê±´ë„ˆë›°ê¸°</option>
        </select>
        <button class="btn" id="import-btn" data-action="importAgent" style="font-size:12px" disabled>ğŸ“¤ Import Agent</button>
      </div>
      <div id="import-result" style="margin-top:8px;font-size:12px"></div>
    </div>
  </div>
  <div class="settings-card">
    <h3 data-i18n="h-update">ğŸ”„ Update</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="update-ver" style="font-size:13px;color:var(--text2)">Current: v<span id="cur-ver"></span></span>
      <button class="btn" style="background:var(--bg3);color:var(--text2)" data-action="checkUpdate"data-i18n="btn-check">Check for Updates</button>
      <button class="btn" id="do-update-btn" style="display:none" data-action="doUpdate">â¬†ï¸ Update</button>
    </div>
    <div id="update-result" style="margin-top:8px;font-size:12px"></div>
  </div>
  </div><!-- end settings-general -->
  <div id="settings-features" style="display:none">
    <div style="margin-bottom:16px"><input id="features-search" type="text" placeholder="Search features..." data-i18n="features-search-ph" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:14px"></div>
    <div id="features-list"></div>
    <div id="features-empty" style="display:none;text-align:center;padding:40px;color:var(--text2);font-size:14px" data-i18n="features-empty">No features found.</div>
  </div>
</div>

<div id="input-area">
  <div class="input-box">
    <textarea id="input" rows="1" placeholder="Type a message..." data-i18n="input-ph"></textarea>
    <button id="thinking-btn" data-action="toggleThinking" title="Extended Thinking" style="width:36px;height:36px;border-radius:10px;border:none;background:var(--bg3);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all 0.15s">ğŸ§ </button>
    <button id="attach-btn" title="Attach file" onclick="document.getElementById('file-input-hidden').click()" style="width:36px;height:36px;border-radius:10px;border:none;background:var(--bg3);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all 0.15s">ğŸ“</button>
    <input type="file" id="file-input-hidden" accept="image/png,image/jpeg,image/gif,image/webp,.txt,.md,.py,.js,.json,.csv,.html,.css,.pdf" style="display:none" onchange="if(this.files[0])window.setFile(this.files[0]);this.value=''">
    <button id="mic-btn" data-action="toggleMic" title="Voice input" style="width:36px;height:36px;border-radius:10px;border:none;background:var(--bg3);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all 0.15s">ğŸ¤</button>
    <button id="send-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
    </button>
  </div>
  <div id="file-preview" style="display:none;padding:8px 0">
    <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--text2)">
      <span id="file-icon">ğŸ“</span>
      <span id="file-name" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
      <span id="file-size"></span>
      <button data-action="clearFile" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px">âœ•</button>
    </div>
    <img id="img-preview" style="display:none;max-height:120px;border-radius:8px;margin-top:8px">
  </div>
  <div class="input-hint" data-i18n="input-hint">Enter to send Â· Shift+Enter newline Â· Ctrl+V paste Â· Drag&Drop files</div>
</div>

<div id="dashboard-view" style="display:none;padding:20px;max-width:1200px;margin:0 auto">
  <div style="margin-bottom:16px"><a href="#" data-action="showChat" style="color:var(--accent);text-decoration:none;font-size:13px" data-i18n="dash-back">â† Back to Chat</a></div>
  <h2 style="margin-bottom:16px" data-i18n="dash-title">ğŸ“ˆ Dashboard</h2>
  <div id="dashboard-content" style="color:var(--text2)" data-i18n="dash-loading">Loading...</div>
</div>

<div id="search-modal">
  <div id="search-box">
    <input id="search-input" type="text" placeholder="ğŸ” Search conversations... (Ctrl+K)" data-i18n-ph="search-ph">
    <div id="search-results"></div>
    <div id="search-hint" data-i18n="search-hint">Esc to close Â· Enter to select Â· Type to search</div>
  </div>
</div>

<script>
(function(){
  const chat=document.getElementById('chat'),input=document.getElementById('input'),
    btn=document.getElementById('send-btn'),costEl=document.getElementById('cost-display'),
    modelBadge=document.getElementById('model-badge'),settingsEl=document.getElementById('settings'),
    filePrev=document.getElementById('file-preview'),fileIconEl=document.getElementById('file-icon'),
    fileNameEl=document.getElementById('file-name'),fileSizeEl=document.getElementById('file-size'),
    imgPrev=document.getElementById('img-preview'),inputArea=document.getElementById('input-area');
  let _tok=sessionStorage.getItem('tok')||'',pendingFile=null;
  var _currentSession=localStorage.getItem('salm_active_session')||'web';
  var _sessionCache={};

  /* Global error handlers â€” catch unhandled promise rejections silently */
  window.addEventListener('unhandledrejection',function(e){e.preventDefault();console.warn('Unhandled:',e.reason)});

  /* --- Session Management --- */
  function _genId(){return 's_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6)}
  function _storageKey(sid){return 'salm_chat_'+sid}

  function loadSessionList(){
    /* Load agents for sidebar dropdown (ì—ì´ì „íŠ¸ ë¡œë“œ) */
    fetch('/api/agents',{headers:{'X-Session-Token':_tok}}).then(function(r){return r.json()}).then(function(d){
      var sel=document.getElementById('agent-select');if(!sel)return;
      var agents=d.agents||[];
      sel.innerHTML=agents.map(function(a){return '<option value="'+a.id+'">ğŸ¤– '+a.display_name+'</option>'}).join('');
    }).catch(function(){});
    fetch('/api/sessions',{headers:{'X-Session-Token':_tok}})
    .then(function(r){return r.json()})
    .then(function(d){
      var el=document.getElementById('session-list');if(!el)return;
      if(!d.sessions||!d.sessions.length){
        el.innerHTML='<div style="padding:8px 12px;opacity:0.5;font-size:12px">'+t('no-sessions')+'</div>';
        return;
      }
      var html='';
      var childMap={};
      d.sessions.forEach(function(s){
        if(s.parent_session_id){
          if(!childMap[s.parent_session_id])childMap[s.parent_session_id]=[];
          childMap[s.parent_session_id].push(s);
        }
      });
      var rendered={};
      function renderSession(s,indent){
        if(rendered[s.id])return '';
        rendered[s.id]=true;
        var active=s.id===_currentSession?' style="background:var(--accent-dim);border-radius:8px"':'';
        var title=s.title||s.id;
        if(title.length>40)title=title.slice(0,40)+'...';
        var pad=indent?'padding-left:'+(10+indent*16)+'px;':'';
        var icon=s.parent_session_id?'â†³ ':'';
        var h='<div class="nav-item session-item"'+active+' data-action="switchSession" data-sid="'+s.id+'" style="'+pad+'">'
          +'<span class="session-title" data-sid="'+s.id+'" title="Double-click to rename" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+icon+title+'</span>'
          +'<span class="session-del" data-action="deleteSession" data-sid="'+s.id+'" title="Delete" style="opacity:0.4;cursor:pointer;padding:2px 4px;font-size:11px">âœ•</span>'
          +'</div>';
        if(childMap[s.id]){childMap[s.id].forEach(function(c){h+=renderSession(c,(indent||0)+1);});}
        return h;
      }
      d.sessions.forEach(function(s){if(!s.parent_session_id)html+=renderSession(s,0);});
      d.sessions.forEach(function(s){if(!rendered[s.id])html+=renderSession(s,1);});
      el.innerHTML=html;
    }).catch(function(){});
  }

  window.switchSession=function(sid){
    /* Save current chat to cache */
    _sessionCache[_currentSession]=chat.innerHTML;
    localStorage.setItem(_storageKey(_currentSession),localStorage.getItem('salm_chat')||'[]');
    /* Switch */
    _currentSession=sid;
    localStorage.setItem('salm_active_session',sid);
    /* Restore from cache or localStorage */
    chat.innerHTML='';
    localStorage.removeItem('salm_chat');
    var stored=localStorage.getItem(_storageKey(sid));
    if(stored){
      localStorage.setItem('salm_chat',stored);
      var hist=JSON.parse(stored);
      if(hist.length){window._restoring=true;hist.forEach(function(m){addMsg(m.role,m.text,m.model)});window._restoring=false}
    }
    loadSessionList();
    /* Return to chat view if on settings/usage/dashboard */
    showChat();
    /* Close sidebar on mobile */
    var sb=document.getElementById('sidebar');if(sb&&sb.classList.contains('open'))toggleSidebar();
  };

  window.newSession=function(){
    var sid=_genId();
    _sessionCache[_currentSession]=chat.innerHTML;
    localStorage.setItem(_storageKey(_currentSession),localStorage.getItem('salm_chat')||'[]');
    _currentSession=sid;
    localStorage.setItem('salm_active_session',sid);
    localStorage.removeItem('salm_chat');
    chat.innerHTML='';
    addMsg('system',t('new-session-msg'));
    loadSessionList();
    var sb=document.getElementById('sidebar');if(sb&&sb.classList.contains('open'))toggleSidebar();
  };

  window.deleteSession=function(sid){
    if(!confirm(t('confirm-delete')))return;
    fetch('/api/sessions/delete',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
      body:JSON.stringify({session_id:sid})}).then(function(){
      localStorage.removeItem(_storageKey(sid));
      delete _sessionCache[sid];
      if(sid===_currentSession){
        _currentSession='web';
        localStorage.setItem('salm_active_session','web');
        localStorage.removeItem('salm_chat');
        chat.innerHTML='';
        addMsg('system',t('new-session-msg'));
      }
      loadSessionList();
    }).catch(function(){});
  };

  /* --- Restore chat history --- */
  (function(){
    var stored=localStorage.getItem(_storageKey(_currentSession));
    if(stored)localStorage.setItem('salm_chat',stored);
    var hist=JSON.parse(localStorage.getItem('salm_chat')||'[]');
    if(hist.length){window._restoring=true;hist.forEach(function(m){addMsg(m.role,m.text,m.model)});window._restoring=false}
    loadSessionList();
  })();

  /* --- Export chat --- */
  window.exportChat=function(fmt){
    var hist=JSON.parse(localStorage.getItem('salm_chat')||'[]');
    if(!hist.length){addMsg('assistant',t('no-chat-export'));return}
    var content='';
    if(fmt==='json'){
      content=JSON.stringify(hist,null,2);
      var blob=new Blob([content],{type:'application/json'});
      var a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download='salmalm_chat_'+new Date().toISOString().slice(0,10)+'.json';a.click();
    }else{
      hist.forEach(function(m){
        var role=m.role==='user'?'ğŸ‘¤ User':'ğŸ˜ˆ SalmAlm';
        content+=role+'\n'+m.text+'\n\n---\n\n';
      });
      var blob=new Blob([content],{type:'text/markdown'});
      var a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download='salmalm_chat_'+new Date().toISOString().slice(0,10)+'.md';a.click();
    }
  };

  /* --- New chat --- */
  window.newChat=function(){
    window.newSession();
  };

  /* --- Theme --- */
  var _theme=localStorage.getItem('salm_theme')||'dark';
  if(_theme==='light')document.documentElement.setAttribute('data-theme','light');
  window.toggleTheme=function(){
    _theme=_theme==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme',_theme==='light'?'light':'');
    localStorage.setItem('salm_theme',_theme);
    var btn=document.getElementById('theme-toggle');
    btn.textContent=_theme==='dark'?'ğŸŒ™':'â˜€ï¸';
  };
  document.getElementById('theme-toggle').textContent=_theme==='dark'?'ğŸŒ™':'â˜€ï¸';

  /* --- Sidebar toggle (mobile) --- */
  window.toggleSidebar=function(){
    var sb=document.getElementById('sidebar'),ov=document.getElementById('side-overlay');
    sb.classList.toggle('open');ov.classList.toggle('open');
  };

  /* --- Quick command from sidebar --- */
  window.quickCmd=function(msg){
    input.value=msg;doSend();
    /* close sidebar on mobile */
    var sb=document.getElementById('sidebar');if(sb.classList.contains('open'))toggleSidebar();
  };

  /* --- Helpers --- */
  var _copyId=0;
  function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
  function renderMd(t){
    if(t.startsWith('<img ')||t.startsWith('<audio '))return t;
    /* Extract code blocks first, escape everything else, then restore */
    var codeBlocks=[];
    t=t.replace(/```(\w+)?\n?([\s\S]*?)```/g,function(_,lang,code){
      _copyId++;var id='cp'+_copyId;
      var safe='<pre style="position:relative"><button class="copy-btn" data-action="copyCode" data-copy-id="'+id+'" id="btn'+id+'">ğŸ“‹ Copy</button><code id="'+id+'">'+(lang?'/* '+lang+' */\n':'')+escHtml(code)+'</code></pre>';
      codeBlocks.push(safe);return '%%CODEBLOCK'+(codeBlocks.length-1)+'%%';
    });
    /* Escape remaining HTML to prevent XSS */
    t=escHtml(t);
    /* Restore code blocks */
    for(var ci=0;ci<codeBlocks.length;ci++){t=t.replace('%%CODEBLOCK'+ci+'%%',codeBlocks[ci])}
    t=t.replace(/`([^`]+)`/g,function(_,c){return '<code>'+c+'</code>'});
    t=t.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
    t=t.replace(/\*([^*]+)\*/g,'<em>$1</em>');
    /* Tables */
    t=t.replace(/^\|(.+)\|\s*$/gm,function(_,row){
      var cells=row.split('|').map(function(c){return c.trim()});
      if(cells.every(function(c){return /^[-:]+$/.test(c)}))return '';
      return '<tr>'+cells.map(function(c){return '<td style="padding:4px 8px;border:1px solid var(--border)">'+c+'</td>'}).join('')+'</tr>';
    });
    t=t.replace(/((<tr>.*?<[/]tr>\s*)+)/g,'<table style="border-collapse:collapse;margin:8px 0;font-size:13px">$1</table>');
    t=t.replace(/^### (.+)$/gm,'<h4 style="margin:8px 0 4px;font-size:13px;color:var(--accent2)">$1</h4>');
    t=t.replace(/^## (.+)$/gm,'<h3 style="margin:10px 0 6px;font-size:14px;color:var(--accent2)">$1</h3>');
    t=t.replace(/^# (.+)$/gm,'<h2 style="margin:12px 0 8px;font-size:16px;color:var(--accent2)">$1</h2>');
    t=t.replace(/^[â€¢\-] (.+)$/gm,'<div style="padding-left:16px;position:relative"><span style="position:absolute;left:4px">â€¢</span>$1</div>');
    t=t.replace(/^(\d+)\. (.+)$/gm,'<div style="padding-left:16px">$1. $2</div>');
    t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" style="color:var(--accent2);text-decoration:underline">$1</a>');
    t=t.replace(/uploads[/]([\w.-]+[.](png|jpg|jpeg|gif|webp))/gi,'<img src="/uploads/$1" style="max-width:400px;max-height:400px;border-radius:8px;display:block;margin:8px 0;cursor:pointer" alt="$1" data-action="openImage">');
    t=t.replace(/uploads[/]([\w.-]+[.](mp3|wav|ogg))/gi,'<audio controls src="/uploads/$1" style="display:block;margin:8px 0"></audio> ğŸ”Š $1');
    t=t.replace(/\n/g,'<br>');
    return t;
  }
  window.copyCode=function(id){
    var el=document.getElementById(id);if(!el)return;
    navigator.clipboard.writeText(el.textContent).then(function(){
      var btn=document.getElementById('btn'+id);btn.textContent='âœ… Copied';
      setTimeout(function(){btn.textContent='ğŸ“‹ Copy'},1500);
    });
  };
  function addMsg(role,text,model){
    const row=document.createElement('div');row.className='msg-row '+role;
    const av=document.createElement('div');av.className='avatar';
    av.textContent=role==='user'?'ğŸ‘¤':'ğŸ˜ˆ';
    const wrap=document.createElement('div');
    const bubble=document.createElement('div');bubble.className='bubble';
    /* Parse inline buttons marker: <!--buttons:["a","b","c"]--> */
    var _btnLabels=[];
    var _cleanText=text.replace(/<!--buttons:(\[.*?\])-->/g,function(_,j){try{_btnLabels=JSON.parse(j)}catch(e){}return ''});
    bubble.innerHTML=renderMd(_cleanText);
    if(role==='assistant'&&_btnLabels.length>0){
      var _btnRow=document.createElement('div');_btnRow.style.cssText='display:flex;flex-wrap:wrap;gap:6px;margin-top:8px';
      _btnLabels.forEach(function(label){
        var _b=document.createElement('button');_b.textContent=label;
        _b.style.cssText='padding:6px 14px;border-radius:16px;border:1px solid var(--accent);background:transparent;color:var(--accent);cursor:pointer;font-size:13px;transition:all 0.15s';
        _b.onmouseenter=function(){_b.style.background='var(--accent)';_b.style.color='#fff'};
        _b.onmouseleave=function(){_b.style.background='transparent';_b.style.color='var(--accent)'};
        _b.onclick=function(){input.value=label;doSend()};
        _btnRow.appendChild(_b);
      });
      bubble.appendChild(_btnRow);
    }
    wrap.appendChild(bubble);
    var meta_parts=[];
    if(model){
      /* Show model as badge */
      var modelShort=model.replace(/anthropic\//,'').replace(/openai\//,'').replace(/xai\//,'').replace(/google\//,'');
      meta_parts.push(modelShort);
    }
    meta_parts.push(new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}));
    var mt=document.createElement('div');mt.className='meta';
    /* Add model badge if present */
    if(model&&role==='assistant'){
      var _mShort=(model||'').split('/').pop()||model;
      if(_mShort.length>30)_mShort=_mShort.slice(0,30);
      var badge=document.createElement('span');badge.className='model-tag';badge.textContent=_mShort;
      mt.appendChild(badge);
    }
    mt.appendChild(document.createTextNode(meta_parts.filter(function(p){return!p.includes('/')}).join(' Â· ')));
    /* TTS button for assistant messages */
    if(role==='assistant'&&_cleanText&&_cleanText.length>5){
      var ttsBtn=document.createElement('button');ttsBtn.className='tts-btn';ttsBtn.textContent='ğŸ”Š';ttsBtn.title=t('btn-tts-title');
      ttsBtn.onclick=function(){
        if('speechSynthesis' in window){
          window.speechSynthesis.cancel();
          var utter=new SpeechSynthesisUtterance(_cleanText.replace(/<[^>]*>/g,'').replace(/```[\s\S]*?```/g,'').slice(0,5000));
          utter.lang=navigator.language||'ko-KR';
          utter.rate=1.0;
          ttsBtn.textContent='ğŸ”‡';
          utter.onend=function(){ttsBtn.textContent='ğŸ”Š'};
          utter.onerror=function(){ttsBtn.textContent='ğŸ”Š'};
          window.speechSynthesis.speak(utter);
        }
      };
      mt.appendChild(ttsBtn);
    }
    if(role==='assistant'&&text){
      var regenBtn=document.createElement('span');
      regenBtn.textContent=' ğŸ”„';regenBtn.style.cursor='pointer';regenBtn.title=t('btn-regen-title');
      regenBtn.onclick=function(){
        var hist=JSON.parse(localStorage.getItem('salm_chat')||'[]');
        /* Find last user message */
        for(var i=hist.length-1;i>=0;i--){if(hist[i].role==='user'){
          /* Remove this assistant msg and resend */
          hist.splice(i+1);localStorage.setItem('salm_chat',JSON.stringify(hist));
          row.remove();input.value=hist[i].text||'';doSend();break;
        }}
      };
      mt.appendChild(regenBtn);
    }
    /* Edit/Delete buttons for user messages */
    if(role==='user'&&text&&!text.startsWith('<img ')){
      var editActions=document.createElement('span');editActions.className='msg-edit-actions';
      var editBtn=document.createElement('button');editBtn.textContent='âœï¸';editBtn.title=t('btn-edit');
      editBtn.onclick=function(){
        var origText=text;
        var ta=document.createElement('textarea');ta.className='edit-textarea';ta.value=origText.replace(/<[^>]*>/g,'');
        var bar=document.createElement('div');bar.className='edit-bar';
        var saveB=document.createElement('button');saveB.className='save-btn';saveB.textContent=t('edit-save');
        var cancelB=document.createElement('button');cancelB.className='cancel-btn';cancelB.textContent=t('edit-cancel');
        bar.appendChild(saveB);bar.appendChild(cancelB);
        bubble.innerHTML='';bubble.appendChild(ta);bubble.appendChild(bar);
        ta.focus();ta.setSelectionRange(ta.value.length,ta.value.length);
        cancelB.onclick=function(){bubble.innerHTML=renderMd(origText)};
        saveB.onclick=function(){
          var newText=ta.value.trim();if(!newText)return;
          var allMsgs=chat.querySelectorAll('.msg-row');
          var idx=-1;for(var ei=0;ei<allMsgs.length;ei++){if(allMsgs[ei]===row){idx=ei;break;}}
          fetch('/api/messages/edit',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
            body:JSON.stringify({session_id:_currentSession,message_index:idx,content:newText})})
          .then(function(r){return r.json()}).then(function(d){
            if(d.ok){
              bubble.innerHTML=renderMd(newText);text=newText;
              var allAfter=chat.querySelectorAll('.msg-row');
              for(var ri=allAfter.length-1;ri>idx;ri--){allAfter[ri].remove();}
              var hist=JSON.parse(localStorage.getItem('salm_chat')||'[]');
              hist=hist.slice(0,idx+1);hist[idx]={role:'user',text:newText,model:null};
              localStorage.setItem('salm_chat',JSON.stringify(hist));
              localStorage.setItem(_storageKey(_currentSession),JSON.stringify(hist));
              if(confirm(t('confirm-regen-after-edit'))){input.value=newText;doSend();}
            }else{bubble.innerHTML=renderMd(origText);alert(d.error||'Edit failed');}
          }).catch(function(){bubble.innerHTML=renderMd(origText)});
        };
        ta.addEventListener('keydown',function(ev){if(ev.key==='Enter'&&!ev.shiftKey){ev.preventDefault();saveB.click();}if(ev.key==='Escape'){cancelB.click();}});
      };
      var delBtn=document.createElement('button');delBtn.textContent='ğŸ—‘ï¸';delBtn.title=t('btn-delete');
      delBtn.onclick=function(){
        if(!confirm(t('confirm-delete-msg')))return;
        var allMsgs=chat.querySelectorAll('.msg-row');
        var idx=-1;for(var di=0;di<allMsgs.length;di++){if(allMsgs[di]===row){idx=di;break;}}
        fetch('/api/messages/delete',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
          body:JSON.stringify({session_id:_currentSession,message_index:idx})})
        .then(function(r){return r.json()}).then(function(d){
          if(d.ok){
            row.remove();
            var nextRow=chat.querySelectorAll('.msg-row')[idx];
            if(nextRow&&nextRow.classList.contains('assistant'))nextRow.remove();
            var hist=JSON.parse(localStorage.getItem('salm_chat')||'[]');
            hist.splice(idx,d.removed||1);
            localStorage.setItem('salm_chat',JSON.stringify(hist));
            localStorage.setItem(_storageKey(_currentSession),JSON.stringify(hist));
          }else{alert(d.error||'Delete failed');}
        });
      };
      editActions.appendChild(editBtn);editActions.appendChild(delBtn);
      mt.appendChild(editActions);
    }
    var branchBtn=document.createElement('span');
    branchBtn.textContent=' ğŸŒ¿';branchBtn.style.cssText='cursor:pointer;opacity:0;transition:opacity 0.15s;font-size:12px';
    branchBtn.title=t('btn-branch-title');
    branchBtn.onclick=function(){
      var allMsgs=chat.querySelectorAll('.msg-row');
      var idx=-1;for(var bi=0;bi<allMsgs.length;bi++){if(allMsgs[bi]===row){idx=bi;break;}}
      if(idx<0)return;
      fetch('/api/sessions/branch',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
        body:JSON.stringify({session_id:_currentSession,message_index:idx})})
      .then(function(r){return r.json()}).then(function(d){
        if(d.ok){switchSession(d.new_session_id);loadSessionList();}
        else{alert(d.error||t('branch-fail'));}
      });
    };
    mt.appendChild(branchBtn);
    row.onmouseenter=function(){branchBtn.style.opacity='0.7'};
    row.onmouseleave=function(){branchBtn.style.opacity='0'};
    wrap.appendChild(mt);
    row.appendChild(av);row.appendChild(wrap);
    chat.appendChild(row);chat.scrollTop=999999;
    if(!window._restoring){
      var hist=JSON.parse(localStorage.getItem('salm_chat')||'[]');
      hist.push({role:role,text:text,model:model||null});
      if(hist.length>200)hist=hist.slice(-200);
      localStorage.setItem('salm_chat',JSON.stringify(hist));
      localStorage.setItem(_storageKey(_currentSession),JSON.stringify(hist));
      /* Auto-refresh session list after first user message */
      if(role==='user'&&hist.filter(function(m){return m.role==='user'}).length===1)setTimeout(loadSessionList,500);
    }
  }
  function addTyping(statusText){
    const row=document.createElement('div');row.className='msg-row assistant';row.id='typing-row';
    const av=document.createElement('div');av.className='avatar';av.textContent='ğŸ˜ˆ';
    const wrap=document.createElement('div');
    const b=document.createElement('div');b.className='bubble';
    var label=statusText||'';
    b.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>'+(label?' '+label:'');
    wrap.appendChild(b);row.appendChild(av);row.appendChild(wrap);
    chat.appendChild(row);chat.scrollTop=999999;
  }
  function updateTypingStatus(status, detail){
    var el=document.getElementById('typing-row');
    if(!el)return;
    var b=el.querySelector('.bubble');
    if(!b||b._streaming)return;
    var label='';
    if(status==='thinking')label='ğŸ§  Thinking...';
    else if(status==='tool_running')label=detail||'ğŸ”§ Running tool...';
    else label=detail||'';
    b.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>'+(label?' '+label:'');
  }

  /* --- File handling --- */
  window.setFile=function(file){
    if(file.type.startsWith('image/')&&file.size>5*1024*1024){alert(t('img-too-large'));return}
    pendingFile=file;
    const isImg=file.type.startsWith('image/');
    fileIconEl.textContent=isImg?'ğŸ–¼ï¸':'ğŸ“';
    fileNameEl.textContent=file.name;
    fileSizeEl.textContent=(file.size/1024).toFixed(1)+'KB';
    filePrev.style.display='block';
    if(isImg){const r=new FileReader();r.onload=function(e){imgPrev.src=e.target.result;imgPrev.style.display='block'};r.readAsDataURL(file)}
    else{imgPrev.style.display='none'}
    input.focus();
  };
  window.clearFile=function(){pendingFile=null;filePrev.style.display='none';imgPrev.style.display='none'};

  /* --- Ctrl+V --- */
  document.addEventListener('paste',function(e){
    var items=e.clipboardData&&e.clipboardData.items;if(!items)return;
    for(var i=0;i<items.length;i++){
      if(items[i].kind==='file'){e.preventDefault();var f=items[i].getAsFile();if(f)window.setFile(f);return}
    }
  });

  /* --- Drag & drop --- */
  /* Fullscreen dropzone overlay */
  var _dragCtr=0;
  var _dropOv=document.createElement('div');
  _dropOv.style.cssText='display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(99,102,241,0.15);z-index:9999;pointer-events:none;align-items:center;justify-content:center';
  _dropOv.innerHTML='<div style="padding:32px 48px;background:var(--bg2);border:3px dashed var(--accent);border-radius:16px;color:var(--accent);font-size:20px;font-weight:600;pointer-events:none" data-i18n="drop-overlay">ğŸ“ Drop image or file here</div>';
  document.body.appendChild(_dropOv);
  document.addEventListener('dragenter',function(e){e.preventDefault();_dragCtr++;if(_dragCtr===1)_dropOv.style.display='flex'});
  document.addEventListener('dragleave',function(e){e.preventDefault();_dragCtr--;if(_dragCtr<=0){_dragCtr=0;_dropOv.style.display='none'}});
  document.addEventListener('dragover',function(e){e.preventDefault()});
  document.addEventListener('drop',function(e){e.preventDefault();_dragCtr=0;_dropOv.style.display='none';
    var f=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0];if(f)window.setFile(f)});

  /* --- WebSocket Connection Manager --- */
  var _ws=null,_wsReady=false,_wsBackoff=500,_wsMaxBackoff=5000,_wsTimer=null,_wsPingTimer=null;
  var _wsPendingResolve=null,_wsSendStart=0;

  function _wsUrl(){
    var proto=location.protocol==='https:'?'wss:':'ws:';
    var host=location.hostname||'localhost';
    return proto+'//'+host+':18801';
  }

  function _wsConnect(){
    if(_ws&&(_ws.readyState===WebSocket.CONNECTING||_ws.readyState===WebSocket.OPEN))return;
    try{_ws=new WebSocket(_wsUrl())}catch(e){console.warn('WS connect error:',e);_wsScheduleReconnect();return}
    _ws.onopen=function(){
      _wsReady=true;_wsBackoff=500;
      console.log('WS connected');
      _wsStartPing();
    };
    _ws.onclose=function(){
      _wsReady=false;_wsStopPing();
      if(_wsPendingResolve){_wsPendingResolve({fallback:true});_wsPendingResolve=null}
      _wsScheduleReconnect();
    };
    _ws.onerror=function(){_wsReady=false};
    _ws.onmessage=function(ev){
      var data;try{data=JSON.parse(ev.data)}catch(e){return}
      if(data.type==='pong')return;
      if(data.type==='welcome')return;
      if(data.type==='typing'){updateTypingStatus(data.status,data.detail);return;}
      _wsHandleMessage(data);
    };
  }

  function _wsScheduleReconnect(){
    if(_wsTimer)return;
    _wsTimer=setTimeout(function(){_wsTimer=null;_wsConnect()},_wsBackoff);
    _wsBackoff=Math.min(_wsBackoff*2,_wsMaxBackoff);
  }

  function _wsStartPing(){
    _wsStopPing();
    _wsPingTimer=setInterval(function(){
      if(_ws&&_ws.readyState===WebSocket.OPEN)_ws.send(JSON.stringify({type:'ping'}));
    },30000);
  }
  function _wsStopPing(){if(_wsPingTimer){clearInterval(_wsPingTimer);_wsPingTimer=null}}

  function _wsHandleMessage(data){
    var typingEl=document.getElementById('typing-row');
    if(data.type==='chunk'){
      if(typingEl){var tb=typingEl.querySelector('.bubble');if(tb){if(!tb._streaming){tb._streaming=true;tb.innerHTML=''}tb.innerHTML+=data.text.replace(/</g,'&lt;')}}
    }else if(data.type==='tool'){
      if(typingEl){var tb2=typingEl.querySelector('.bubble');if(tb2)tb2.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div> ğŸ”§ '+data.name+'...'}
    }else if(data.type==='done'){
      if(typingEl)typingEl.remove();
      var _secs=((Date.now()-_wsSendStart)/1000).toFixed(1);
      addMsg('assistant',data.text||'','â±ï¸'+_secs+'s');
      fetch('/api/status').then(function(r){return r.json()}).then(function(s){costEl.textContent='$'+s.usage.total_cost.toFixed(4)});
      if(_wsPendingResolve){_wsPendingResolve({done:true});_wsPendingResolve=null}
    }else if(data.type==='error'){
      if(typingEl)typingEl.remove();
      addMsg('assistant','âŒ '+data.error);
      if(_wsPendingResolve){_wsPendingResolve({done:true});_wsPendingResolve=null}
    }else if(data.type==='shutdown'){
      if(typingEl)typingEl.remove();
      addMsg('assistant','âš ï¸ '+(data.message||'Server is shutting down...'));
      if(_wsPendingResolve){_wsPendingResolve({done:true});_wsPendingResolve=null}
    }
  }

  /* Connect on load */
  _wsConnect();

  /* --- Send via WebSocket with SSE fallback --- */
  function _sendViaWs(msg,session){
    return new Promise(function(resolve){
      if(!_wsReady||!_ws||_ws.readyState!==WebSocket.OPEN){resolve({fallback:true});return}
      _wsPendingResolve=resolve;
      var _wsPayload={type:'message',text:msg,session:session};
      if(window._pendingWsImage){_wsPayload.image=window._pendingWsImage.data;_wsPayload.image_mime=window._pendingWsImage.mime;window._pendingWsImage=null}
      _ws.send(JSON.stringify(_wsPayload));
    });
  }

  async function _sendViaSse(chatBody,_sendStart){
    try{
      var r=await fetch('/api/chat/stream',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
        body:JSON.stringify(chatBody)});
      if(!r.ok||!r.body){throw new Error('stream unavailable')}
      var reader=r.body.getReader();var decoder=new TextDecoder();var buf='';var gotDone=false;
      var typingEl=document.getElementById('typing-row');
      while(true){
        var chunk=await reader.read();
        if(chunk.done)break;
        buf+=decoder.decode(chunk.value,{stream:true});
        var evts=buf.split('\n\n');buf=evts.pop();
        for(var i=0;i<evts.length;i++){
          var evt=evts[i];
          var em=evt.match(/^event: (\w+)\ndata: (.+)$/m);
          if(!em)continue;
          var etype=em[1],edata=JSON.parse(em[2]);
          if(etype==='status'){
            if(typingEl){var tb=typingEl.querySelector('.bubble');if(tb)tb.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div> '+edata.text}
          }else if(etype==='tool'){
            if(typingEl){var tb2=typingEl.querySelector('.bubble');if(tb2)tb2.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div> ğŸ”§ '+edata.name+(edata.count?' ('+edata.count+')':'')+'...'}
          }else if(etype==='chunk'){
            if(typingEl){var tb4=typingEl.querySelector('.bubble');if(tb4){if(!tb4._streaming){tb4._streaming=true;tb4.innerHTML=''}tb4.innerHTML+=edata.text.replace(/</g,'&lt;')}}
          }else if(etype==='done'){
            gotDone=true;
            if(typingEl)typingEl.remove();
            var _secs=((Date.now()-_sendStart)/1000).toFixed(1);
            addMsg('assistant',edata.response||'',(edata.model||'')+' Â· â±ï¸'+_secs+'s');
            fetch('/api/status').then(function(r2){return r2.json()}).then(function(s){costEl.textContent='$'+s.usage.total_cost.toFixed(4)});
          }
        }
      }
      if(!gotDone)throw new Error('stream incomplete');
      if(document.getElementById('typing-row'))document.getElementById('typing-row').remove();
    }catch(streamErr){
      console.warn('SSE failed, falling back:',streamErr);
      var typRow=document.getElementById('typing-row');
      if(typRow){var tb3=typRow.querySelector('.bubble');if(tb3)tb3.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div> Processing...'}
      var r2=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
        body:JSON.stringify(chatBody)});
      var d=await r2.json();
      if(document.getElementById('typing-row'))document.getElementById('typing-row').remove();
      var _secs2=((Date.now()-_sendStart)/1000).toFixed(1);
      if(d.response)addMsg('assistant',d.response,(d.model||'')+' Â· â±ï¸'+_secs2+'s');
      else if(d.error)addMsg('assistant','âŒ '+d.error);
      fetch('/api/status').then(function(r3){return r3.json()}).then(function(s){costEl.textContent='$'+s.usage.total_cost.toFixed(4)});
    }
  }

  /* --- Send --- */
  async function doSend(){
    var t=input.value.trim();
    if(!t&&!pendingFile)return;
    /* Client-side /rollback N command */
    var rollMatch=t.match(/^\/rollback\s+(\d+)$/);
    if(rollMatch){
      input.value='';
      var cnt=parseInt(rollMatch[1]);
      fetch('/api/sessions/rollback',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
        body:JSON.stringify({session_id:_currentSession,count:cnt})})
      .then(function(r){return r.json()}).then(function(d){
        if(d.ok){
          addMsg('assistant',t('rollback-done')+' '+d.removed+' '+t('rollback-pairs'));
          /* Reload session */
          switchSession(_currentSession);
        }else{addMsg('assistant',t('rollback-fail')+' '+(d.error||''));}
      });
      return;
    }
    /* Client-side /branch command */
    if(t==='/branch'){
      input.value='';
      var allMsgs=chat.querySelectorAll('.msg-row');
      var idx=allMsgs.length-1;
      fetch('/api/sessions/branch',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
        body:JSON.stringify({session_id:_currentSession,message_index:idx})})
      .then(function(r){return r.json()}).then(function(d){
        if(d.ok){switchSession(d.new_session_id);loadSessionList();}
        else{addMsg('assistant',t('branch-fail')+' '+(d.error||''));}
      });
      return;
    }
    input.value='';input.style.height='auto';btn.disabled=true;

    var fileMsg='';var imgData=null;var imgMime=null;
    if(pendingFile){
      var isImg=pendingFile.type.startsWith('image/');
      if(isImg){
        var reader=new FileReader();
        var previewUrl=await new Promise(function(res){reader.onload=function(){res(reader.result)};reader.readAsDataURL(pendingFile)});
        addMsg('user','<img src="'+previewUrl+'" style="max-width:300px;max-height:300px;border-radius:8px;display:block;margin:4px 0" alt="'+pendingFile.name+'">');
      }else{addMsg('user','[ğŸ“ '+pendingFile.name+' Uploading...]')}
      var fd=new FormData();fd.append('file',pendingFile);
      try{
        var ur=await fetch('/api/upload',{method:'POST',body:fd});
        var ud=await ur.json();
        if(ud.ok){fileMsg=ud.info;if(ud.image_base64){imgData=ud.image_base64;imgMime=ud.image_mime;window._pendingWsImage={data:imgData,mime:imgMime}}}
        else addMsg('assistant',t('upload-fail')+' '+(ud.error||''));
      }catch(ue){addMsg('assistant',t('upload-error')+' '+ue.message)}
      window.clearFile();
    }

    var msg=(fileMsg?fileMsg+'\n':'')+t;
    if(t)addMsg('user',t);
    if(!msg){btn.disabled=false;return}

    addTyping();
    var _sendStart=Date.now();
    _wsSendStart=_sendStart;
    var chatBody={message:msg,session:_currentSession};
    if(imgData){chatBody.image_base64=imgData;chatBody.image_mime=imgMime}
    try{
      /* Try WebSocket first, fall back to SSE */
      var wsResult=await _sendViaWs(msg,_currentSession);
      if(wsResult.fallback){
        await _sendViaSse(chatBody,_sendStart);
      }
    }catch(se){var tr2=document.getElementById('typing-row');if(tr2)tr2.remove();addMsg('assistant','âŒ Error: '+se.message)}
    finally{btn.disabled=false;input.focus()}
  }
  window.doSend=doSend;

  /* --- Key handler --- */
  input.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend()}
  });
  input.addEventListener('input',function(){input.style.height='auto';input.style.height=Math.min(input.scrollHeight,150)+'px'});
  btn.addEventListener('click',function(){doSend()});

  /* --- i18n --- */
  var _i18n={
    en:{
      'nav-chat':'ğŸ’¬ Chat','nav-settings':'âš™ï¸ Settings',
      'tab-general':'âš™ï¸ General','tab-features':'ğŸ“– Features',
      'features-search-ph':'Search features...','features-empty':'No features found.',
      'h-model':'ğŸ¤– Model Settings','h-keys':'ğŸ”‘ API Key Management','h-update':'ğŸ”„ Update','h-lang':'ğŸŒ Language',
      'lbl-model':'Default Model','lbl-ollama':'Ollama URL',
      'btn-save':'Save','btn-test':'Test','btn-check':'Check for Updates','btn-update':'â¬†ï¸ Update',
      'btn-export':'ğŸ“¥ Export','btn-send':'Send',
      'lbl-anthropic':'Anthropic API Key','lbl-openai':'OpenAI API Key',
      'lbl-xai':'xAI API Key (Grok)','lbl-google':'Google API Key (Gemini)','lbl-brave':'Brave Search API Key',
      'welcome-title':'Welcome to SalmAlm','welcome-sub':'Your personal AI gateway',
      'input-ph':'Type a message...',
      'usage-input':'Input','usage-output':'Output','usage-cost':'Cost','usage-uptime':'Uptime',
      'h-vault':'ğŸ—ï¸ Stored Keys','h-usage':'ğŸ“Š Usage',
      'update-uptodate':'âœ… You are up to date','update-checking':'â³ Checking PyPI...',
      'update-new':'ğŸ†• New version','update-available':'available!','update-download':'â¬‡ï¸ Download',
      'update-installing':'Running pip install --upgrade salmalm...',
      'nav-webchat':'Web Chat','nav-sysmon':'System Monitor','nav-memory':'Memory',
      'nav-cost':'Cost Tracker','nav-cron':'Cron Manager','nav-python':'Python Exec',
      'nav-image':'Image Gen','nav-tts':'TTS','nav-calendar':'Calendar','nav-mail':'Mail',
      'nav-weather':'Weather','nav-rss':'RSS','nav-remind':'Reminders','nav-translate':'Translate',
      'nav-workflow':'Workflows','nav-qr':'QR Code','nav-notify':'Notifications','nav-fileindex':'File Search',
      'btn-save-ollama':'Save Ollama URL','btn-newchat':'ğŸ—¨ New Chat',
      'sec-chats':'ğŸ’¬ Chats','sec-channels':'Channels','sec-admin':'Admin',
      'h-password':'ğŸ”’ Master Password',
      'pw-current':'Current Password','pw-new':'New Password','pw-confirm':'Confirm New Password',
      'pw-new-hint':'New password (4+ chars, leave empty to remove)','pw-confirm-hint':'Re-enter new password',
      'pw-change':'Change','pw-remove':'Remove Password','pw-set':'Set Password',
      'pw-not-set':'No password is currently set.',
      'pw-min4':'Password (4+ characters)','pw-reenter':'Re-enter',
      'pw-mismatch':'New passwords do not match','pw-changed':'âœ… Password changed',
      'pw-fail':'âŒ Change failed','pw-enter-current':'Please enter current password',
      'h-routing':'ğŸ”€ Auto Routing Models',
      'routing-desc':'When "Auto Routing" is selected, messages are classified by complexity and routed to these models:',
      'lbl-route-simple':'âš¡ Simple (greetings, short questions)',
      'lbl-route-moderate':'ğŸ”§ Moderate (code, analysis, summaries)',
      'lbl-route-complex':'ğŸ’ Complex (architecture, long reasoning)',
      'btn-save-routing':'Save Routing',
      'h-soul':'ğŸ“œ SOUL.md (Custom System Prompt)',
      'soul-desc':'Set a custom system prompt. It will be prepended to all conversations.',
      'soul-path':'~/.salmalm/SOUL.md Â· Leave empty to restore default',
      'soul-ph':'# My Custom Persona\n\nYou are ...',
      'btn-save-soul':'ğŸ’¾ Save','btn-reset-soul':'ğŸ”„ Reset',
      'h-google-oauth':'ğŸ”— Google Integration (Calendar & Gmail)',
      'google-oauth-desc':'OAuth2 integration is required for Google Calendar and Gmail features.',
      'google-oauth-console':'Create an OAuth 2.0 Client ID at Google Cloud Console.',
      'lbl-google-client-id':'Google Client ID','lbl-google-client-secret':'Google Client Secret',
      'btn-google-connect':'ğŸ”— Connect Google Account','btn-google-disconnect':'Disconnect',
      'google-guide-title':'ğŸ“‹ Setup Guide',
      'google-guide-1':'Google Cloud Console â†’ Create/Select Project',
      'google-guide-2':'APIs & Services â†’ Credentials â†’ Create OAuth 2.0 Client ID',
      'google-guide-3':'Application type: Web application',
      'google-guide-4':'Authorized redirect URI:',
      'google-guide-5':'Enter Client ID and Client Secret above',
      'google-guide-6':'Click Connect Google Account',
      'google-connected':'ğŸŸ¢ Connected','google-not-connected':'âšª Not connected',
      'google-no-client-id':'âŒ Save Client ID first',
      'google-redirecting':'ğŸ”— Redirecting to Google login...',
      'google-confirm-disconnect':'Disconnect Google integration?',
      'google-disconnected':'âœ… Google integration disconnected',
      'search-ph':'ğŸ” Search conversations... (Ctrl+K)',
      'search-hint':'Esc to close Â· Enter to select Â· Type to search',
      'search-type-to-search':'Type to search across all conversations',
      'search-no-results':'No results for',
      'search-error':'Search error',
      'shortcut-title':'âŒ¨ï¸ Keyboard Shortcuts',
      'shortcut-search':'Search sessions',
      'shortcut-newchat':'New chat','shortcut-sidebar':'Toggle sidebar',
      'shortcut-escape':'Close modal / settings','shortcut-cmdpalette':'Command palette','shortcut-help':'This help',
      'btn-close':'Close',
      'drop-overlay':'ğŸ“ Drop image or file here',
      'input-hint':'Enter to send Â· Shift+Enter newline Â· Ctrl+V paste Â· Drag&Drop files',
      'thinking-on':'ğŸ§  Extended Thinking: ON','thinking-off':'Extended Thinking: OFF',
      'btn-thinking-title':'Extended Thinking','btn-attach-title':'Attach file',
      'btn-mic-title':'Voice input','btn-tts-title':'Read aloud',
      'btn-branch-title':'Branch from here','btn-regen-title':'Regenerate',
      'confirm-delete':'Delete this conversation?',
      'no-sessions':'No conversations yet',
      'new-session-msg':'ğŸ˜ˆ New conversation started.',
      'no-chat-export':'No chat to export.',
      'welcome-msg':'ğŸ˜ˆ Welcome to SalmAlm!\n\nUse on Telegram and Web simultaneously.\nCtrl+V paste image Â· Drag&Drop Â· Enter to send\nType /help for commands',
      'dash-back':'â† Back to Chat','dash-title':'ğŸ“ˆ Dashboard','dash-loading':'Loading...',
      'sidebar-running':'Running',
      'sidebar-channels':'ğŸ“¡ Channels',
      'sidebar-tools':'ğŸ› ï¸ Tools (32) â–¾',
      'filter-ph':'Search sessions...','filter-no-results':'No results',
      'img-too-large':'Image too large (max 5MB)','mic-denied':'Microphone access denied',
      'rollback-done':'âª Rolled back','rollback-pairs':'message pair(s).',
      'rollback-fail':'âŒ Rollback failed:','branch-fail':'âŒ Branch failed:',
      'upload-fail':'âŒ Upload failed:','upload-error':'âŒ Upload error:',
      'btn-edit':'Edit','btn-delete':'Delete',
      'confirm-delete-msg':'Delete this message and its response?',
      'confirm-regen-after-edit':'Regenerate response after edit?',
      'edit-save':'Save','edit-cancel':'Cancel',
      'msg-edited':'âœï¸ Message edited','msg-deleted':'ğŸ—‘ï¸ Message deleted',
      'cmd-placeholder':'Type a command...',
      'cmd-new-chat':'New Chat','cmd-export':'Export Chat','cmd-settings':'Settings',
      'cmd-search':'Search','cmd-theme':'Toggle Theme','cmd-sidebar':'Toggle Sidebar',
      'cmd-dashboard':'Dashboard',
      'shortcut-cmdpalette':'Command palette',
      'pwa-install-text':'Install SalmAlm as an app','pwa-install-btn':'Install','pwa-dismiss':'Later',
    },
    ko:{
      'nav-chat':'ğŸ’¬ ì±„íŒ…','nav-settings':'âš™ï¸ ì„¤ì •',
      'tab-general':'âš™ï¸ ì¼ë°˜','tab-features':'ğŸ“– ê¸°ëŠ¥ ê°€ì´ë“œ',
      'features-search-ph':'ê¸°ëŠ¥ ê²€ìƒ‰...','features-empty':'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.',
      'h-model':'ğŸ¤– ëª¨ë¸ ì„¤ì •','h-keys':'ğŸ”‘ API í‚¤ ê´€ë¦¬','h-update':'ğŸ”„ ì—…ë°ì´íŠ¸','h-lang':'ğŸŒ ì–¸ì–´',
      'lbl-model':'ê¸°ë³¸ ëª¨ë¸','lbl-ollama':'Ollama URL',
      'btn-save':'ì €ì¥','btn-test':'í…ŒìŠ¤íŠ¸','btn-check':'ì—…ë°ì´íŠ¸ í™•ì¸','btn-update':'â¬†ï¸ ì—…ë°ì´íŠ¸',
      'btn-export':'ğŸ“¥ ë‚´ë³´ë‚´ê¸°','btn-send':'ì „ì†¡',
      'lbl-anthropic':'Anthropic API í‚¤','lbl-openai':'OpenAI API í‚¤',
      'lbl-xai':'xAI API í‚¤ (Grok)','lbl-google':'Google API í‚¤ (Gemini)','lbl-brave':'Brave Search API í‚¤',
      'welcome-title':'ì‚¶ì•ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤','welcome-sub':'ë‚˜ë§Œì˜ AI ê²Œì´íŠ¸ì›¨ì´',
      'input-ph':'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...',
      'usage-input':'ì…ë ¥','usage-output':'ì¶œë ¥','usage-cost':'ë¹„ìš©','usage-uptime':'ê°€ë™ì‹œê°„',
      'h-vault':'ğŸ—ï¸ ì €ì¥ëœ í‚¤','h-usage':'ğŸ“Š ì‚¬ìš©ëŸ‰',
      'update-uptodate':'âœ… ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤','update-checking':'â³ PyPI í™•ì¸ ì¤‘...',
      'update-new':'ğŸ†• ìƒˆ ë²„ì „','update-available':'ì‚¬ìš© ê°€ëŠ¥!','update-download':'â¬‡ï¸ ë‹¤ìš´ë¡œë“œ',
      'update-installing':'pip install --upgrade salmalm ì‹¤í–‰ ì¤‘...',
      'nav-webchat':'ì›¹ ì±„íŒ…','nav-sysmon':'ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°','nav-memory':'ë©”ëª¨ë¦¬',
      'nav-cost':'ë¹„ìš© ì¶”ì ','nav-cron':'í¬ë¡  ê´€ë¦¬','nav-python':'Python ì‹¤í–‰',
      'nav-image':'ì´ë¯¸ì§€ ìƒì„±','nav-tts':'ìŒì„± í•©ì„±','nav-calendar':'ìº˜ë¦°ë”','nav-mail':'ë©”ì¼',
      'nav-weather':'ë‚ ì”¨','nav-rss':'ë‰´ìŠ¤ í”¼ë“œ','nav-remind':'ë¦¬ë§ˆì¸ë”','nav-translate':'ë²ˆì—­',
      'nav-workflow':'ì›Œí¬í”Œë¡œìš°','nav-qr':'QR ì½”ë“œ','nav-notify':'ì•Œë¦¼','nav-fileindex':'íŒŒì¼ ê²€ìƒ‰',
      'btn-save-ollama':'Ollama URL ì €ì¥','btn-newchat':'ğŸ—¨ ìƒˆ ëŒ€í™”',
      'sec-chats':'ğŸ’¬ ëŒ€í™”','sec-channels':'ì±„ë„','sec-admin':'ê´€ë¦¬',
      'h-password':'ğŸ”’ ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸',
      'pw-current':'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸','pw-new':'ìƒˆ ë¹„ë°€ë²ˆí˜¸','pw-confirm':'ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸',
      'pw-new-hint':'ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ, ë¹„ìš°ë©´ í•´ì œ)','pw-confirm-hint':'ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥',
      'pw-change':'ë³€ê²½','pw-remove':'ë¹„ë°€ë²ˆí˜¸ í•´ì œ','pw-set':'ë¹„ë°€ë²ˆí˜¸ ì„¤ì •',
      'pw-not-set':'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.',
      'pw-min4':'ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)','pw-reenter':'ë‹¤ì‹œ ì…ë ¥',
      'pw-mismatch':'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤','pw-changed':'âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤',
      'pw-fail':'âŒ ë³€ê²½ ì‹¤íŒ¨','pw-enter-current':'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
      'h-routing':'ğŸ”€ ìë™ ë¼ìš°íŒ… ëª¨ë¸',
      'routing-desc':'ìë™ ë¼ìš°íŒ…ì„ ì„ íƒí•˜ë©´, ë©”ì‹œì§€ê°€ ë³µì¡ë„ì— ë”°ë¼ ë¶„ë¥˜ë˜ì–´ í•´ë‹¹ ëª¨ë¸ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤:',
      'lbl-route-simple':'âš¡ ê°„ë‹¨ (ì¸ì‚¬, ì§§ì€ ì§ˆë¬¸)',
      'lbl-route-moderate':'ğŸ”§ ë³´í†µ (ì½”ë“œ, ë¶„ì„, ìš”ì•½)',
      'lbl-route-complex':'ğŸ’ ë³µì¡ (ì„¤ê³„, ê¸´ ì¶”ë¡ )',
      'btn-save-routing':'ë¼ìš°íŒ… ì €ì¥',
      'h-soul':'ğŸ“œ SOUL.md (ì»¤ìŠ¤í…€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸)',
      'soul-desc':'ì»¤ìŠ¤í…€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ëª¨ë“  ëŒ€í™”ì˜ ì•ì— ì‚½ì…ë©ë‹ˆë‹¤.',
      'soul-path':'~/.salmalm/SOUL.md Â· ë¹„ìš°ë©´ ê¸°ë³¸ê°’ ë³µì›',
      'soul-ph':'# ë‚˜ë§Œì˜ í˜ë¥´ì†Œë‚˜\n\në‹¹ì‹ ì€ ...',
      'btn-save-soul':'ğŸ’¾ ì €ì¥','btn-reset-soul':'ğŸ”„ ì´ˆê¸°í™”',
      'h-google-oauth':'ğŸ”— Google ì—°ë™ (Calendar & Gmail)',
      'google-oauth-desc':'Google Calendar, Gmail ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ OAuth2 ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.',
      'google-oauth-console':'Google Cloud Consoleì—ì„œ OAuth 2.0 Client IDë¥¼ ìƒì„±í•˜ì„¸ìš”.',
      'lbl-google-client-id':'Google Client ID','lbl-google-client-secret':'Google Client Secret',
      'btn-google-connect':'ğŸ”— Google ê³„ì • ì—°ê²°','btn-google-disconnect':'ì—°ê²° í•´ì œ',
      'google-guide-title':'ğŸ“‹ ì„¤ì • ê°€ì´ë“œ',
      'google-guide-1':'Google Cloud Console â†’ í”„ë¡œì íŠ¸ ìƒì„±/ì„ íƒ',
      'google-guide-2':'API ë° ì„œë¹„ìŠ¤ â†’ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ â†’ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID ë§Œë“¤ê¸°',
      'google-guide-3':'ì• í”Œë¦¬ì¼€ì´ì…˜ ìœ í˜•: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜',
      'google-guide-4':'ìŠ¹ì¸ëœ ë¦¬ë””ë ‰ì…˜ URI:',
      'google-guide-5':'Client IDì™€ Client Secretì„ ìœ„ì— ì…ë ¥',
      'google-guide-6':'ğŸ”— Google ê³„ì • ì—°ê²° í´ë¦­',
      'google-connected':'ğŸŸ¢ ì—°ê²°ë¨','google-not-connected':'âšª ì—°ê²° ì•ˆë¨',
      'google-no-client-id':'âŒ Client IDë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”',
      'google-redirecting':'ğŸ”— Google ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...',
      'google-confirm-disconnect':'Google ì—°ë™ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      'google-disconnected':'âœ… Google ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤',
      'search-ph':'ğŸ” ëŒ€í™” ê²€ìƒ‰... (Ctrl+K)',
      'search-hint':'Esc ë‹«ê¸° Â· Enter ì„ íƒ Â· ì…ë ¥í•˜ì—¬ ê²€ìƒ‰',
      'search-type-to-search':'ëª¨ë“  ëŒ€í™”ì—ì„œ ê²€ìƒ‰í•©ë‹ˆë‹¤',
      'search-no-results':'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ:',
      'search-error':'ê²€ìƒ‰ ì˜¤ë¥˜',
      'shortcut-title':'âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤',
      'shortcut-search':'ì„¸ì…˜ ê²€ìƒ‰',
      'shortcut-newchat':'ìƒˆ ëŒ€í™”','shortcut-sidebar':'ì‚¬ì´ë“œë°” í† ê¸€',
      'shortcut-escape':'ëª¨ë‹¬ / ì„¤ì • ë‹«ê¸°','shortcut-cmdpalette':'ì»¤ë§¨ë“œ íŒ”ë ˆíŠ¸','shortcut-help':'ì´ ë„ì›€ë§',
      'btn-close':'ë‹«ê¸°',
      'drop-overlay':'ğŸ“ ì´ë¯¸ì§€ ë˜ëŠ” íŒŒì¼ì„ ë†“ìœ¼ì„¸ìš”',
      'input-hint':'Enter ì „ì†¡ Â· Shift+Enter ì¤„ë°”ê¿ˆ Â· Ctrl+V ë¶™ì—¬ë„£ê¸° Â· íŒŒì¼ ë“œë˜ê·¸&ë“œë¡­',
      'thinking-on':'ğŸ§  í™•ì¥ ì‚¬ê³  ëª¨ë“œ: ì¼œì§','thinking-off':'í™•ì¥ ì‚¬ê³  ëª¨ë“œ: êº¼ì§',
      'btn-thinking-title':'í™•ì¥ ì‚¬ê³  ëª¨ë“œ','btn-attach-title':'íŒŒì¼ ì²¨ë¶€',
      'btn-mic-title':'ìŒì„± ì…ë ¥','btn-tts-title':'ì†Œë¦¬ë¡œ ë“£ê¸°',
      'btn-branch-title':'ì—¬ê¸°ì„œ ë¶„ê¸°','btn-regen-title':'ë‹¤ì‹œ ìƒì„±',
      'confirm-delete':'ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      'no-sessions':'ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤',
      'new-session-msg':'ğŸ˜ˆ ìƒˆ ëŒ€í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
      'no-chat-export':'ë‚´ë³´ë‚¼ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.',
      'welcome-msg':'ğŸ˜ˆ ì‚¶ì•ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\n\nTelegramê³¼ ì›¹ì—ì„œ ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nCtrl+V ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° Â· ë“œë˜ê·¸&ë“œë¡­ Â· Enterë¡œ ì „ì†¡\n/helpë¡œ ëª…ë ¹ì–´ í™•ì¸',
      'dash-back':'â† ì±„íŒ…ìœ¼ë¡œ ëŒì•„ê°€ê¸°','dash-title':'ğŸ“ˆ ëŒ€ì‹œë³´ë“œ','dash-loading':'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...',
      'sidebar-running':'ì‹¤í–‰ ì¤‘',
      'sidebar-channels':'ğŸ“¡ ì±„ë„',
      'sidebar-tools':'ğŸ› ï¸ ë„êµ¬ (32) â–¾',
      'filter-ph':'ì„¸ì…˜ ê²€ìƒ‰...','filter-no-results':'ê²°ê³¼ ì—†ìŒ',
      'img-too-large':'ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ 5MB)','mic-denied':'ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤',
      'rollback-done':'âª ë˜ëŒë¦¬ê¸° ì™„ë£Œ:','rollback-pairs':'ê°œì˜ ë©”ì‹œì§€ ìŒ',
      'rollback-fail':'âŒ ë˜ëŒë¦¬ê¸° ì‹¤íŒ¨:','branch-fail':'âŒ ë¶„ê¸° ì‹¤íŒ¨:',
      'upload-fail':'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:','upload-error':'âŒ ì—…ë¡œë“œ ì˜¤ë¥˜:',
      'btn-edit':'í¸ì§‘','btn-delete':'ì‚­ì œ',
      'confirm-delete-msg':'ì´ ë©”ì‹œì§€ì™€ ì‘ë‹µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      'confirm-regen-after-edit':'í¸ì§‘ í›„ ì‘ë‹µì„ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      'edit-save':'ì €ì¥','edit-cancel':'ì·¨ì†Œ',
      'msg-edited':'âœï¸ ë©”ì‹œì§€ê°€ í¸ì§‘ë˜ì—ˆìŠµë‹ˆë‹¤','msg-deleted':'ğŸ—‘ï¸ ë©”ì‹œì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤',
      'cmd-placeholder':'ëª…ë ¹ì–´ ì…ë ¥...',
      'cmd-new-chat':'ìƒˆ ëŒ€í™”','cmd-export':'ëŒ€í™” ë‚´ë³´ë‚´ê¸°','cmd-settings':'ì„¤ì •',
      'cmd-search':'ê²€ìƒ‰','cmd-theme':'í…Œë§ˆ ì „í™˜','cmd-sidebar':'ì‚¬ì´ë“œë°” ì „í™˜',
      'cmd-dashboard':'ëŒ€ì‹œë³´ë“œ',
      'shortcut-cmdpalette':'ì»¤ë§¨ë“œ íŒ”ë ˆíŠ¸',
      'pwa-install-text':'SalmAlmì„ ì•±ìœ¼ë¡œ ì„¤ì¹˜','pwa-install-btn':'ì„¤ì¹˜','pwa-dismiss':'ë‚˜ì¤‘ì—',
    }
  };
  var _lang=localStorage.getItem('salmalm-lang')||'en';
  function t(k){return (_i18n[_lang]||_i18n.en)[k]||(_i18n.en[k]||k)}
  function applyLang(){
    document.querySelectorAll('[data-i18n]').forEach(function(el){
      var k=el.getAttribute('data-i18n');
      if(el.tagName==='INPUT'||el.tagName==='TEXTAREA')el.placeholder=t(k);
      else el.textContent=t(k);
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(function(el){
      el.placeholder=t(el.getAttribute('data-i18n-ph'));
    });
    // Translate Save/Test buttons by content matching
    document.querySelectorAll('button').forEach(function(btn){
      var txt=btn.textContent.trim();
      if(txt==='Save'||txt==='ì €ì¥')btn.textContent=t('btn-save');
      else if(txt==='Test'||txt==='í…ŒìŠ¤íŠ¸')btn.textContent=t('btn-test');
    });
    var sel=document.getElementById('s-lang');
    if(sel)sel.value=_lang;
  }
  window.setLang=function(v){_lang=v;localStorage.setItem('salmalm-lang',v);applyLang()};
  /* --- Settings --- */
  var dashView=document.getElementById('dashboard-view');
  window.showChat=function(){settingsEl.style.display='none';dashView.style.display='none';chat.style.display='flex';inputArea.style.display='block'};
  window.showSettings=function(){chat.style.display='none';inputArea.style.display='none';dashView.style.display='none';settingsEl.style.display='block';
    /* Load personas */
    if(window.loadPersonas)window.loadPersonas();
    /* Load users panel */
    if(window.loadUsers)window.loadUsers();
    /* Load routing config */
    fetch('/api/routing',{headers:{'X-Session-Token':_tok}}).then(function(r){return r.json()}).then(function(d){
      var cfg=d.config||{};var models=d.available_models||{};
      var opts='';var allModels=[];
      for(var k in models){allModels.push({key:k,val:models[k]})}
      /* Also add model options from the main select */
      var mainSel=document.getElementById('s-model');
      if(mainSel){for(var i=0;i<mainSel.options.length;i++){var o=mainSel.options[i];if(o.value&&o.value!=='auto'){var found=false;for(var j=0;j<allModels.length;j++){if(allModels[j].val===o.value){found=true;break}}if(!found)allModels.push({key:o.value,val:o.value})}}}
      opts='';for(var i=0;i<allModels.length;i++){opts+='<option value="'+allModels[i].val+'">'+allModels[i].val.split('/').pop()+' ('+allModels[i].key+')</option>'}
      ['simple','moderate','complex'].forEach(function(tier){
        var sel=document.getElementById('route-'+tier);if(sel){sel.innerHTML=opts;sel.value=cfg[tier]||''}
      });
    }).catch(function(){});
    /* Load SOUL.md */
    fetch('/api/soul',{headers:{'X-Session-Token':_tok}}).then(function(r){return r.json()}).then(function(d){
      var ed=document.getElementById('soul-editor');if(ed)ed.value=d.content||'';
    }).catch(function(){});
    fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'keys'})})
      .then(function(r){return r.json()}).then(function(d){
        document.getElementById('vault-keys').innerHTML=d.keys.map(function(k){return '<div style="padding:4px 0;font-size:13px;color:var(--text2)">ğŸ”‘ '+k+'</div>'}).join('')});
    if(window.checkGoogleStatus)window.checkGoogleStatus();
    fetch('/api/status').then(function(r){return r.json()}).then(function(d){
      var u=d.usage,h='<div style="font-size:13px;line-height:2">ğŸ“¥ Input: '+u.total_input.toLocaleString()+' tokens<br>ğŸ“¤ Output: '+u.total_output.toLocaleString()+' tokens<br>ğŸ’° Cost: $'+u.total_cost.toFixed(4)+'<br>â±ï¸ Uptime: '+u.elapsed_hours+'h</div>';
      if(u.by_model){h+='<div style="margin-top:12px;font-size:12px">';for(var m in u.by_model){var v=u.by_model[m];h+='<div style="padding:4px 0;color:var(--text2)">'+m+': '+v.calls+'calls Â· $'+v.cost.toFixed(4)+'</div>'}h+='</div>'}
      document.getElementById('usage-detail').innerHTML=h});
  };
  window.showUsage=window.showSettings;

  /* --- Settings Tabs --- */
  document.querySelectorAll('.settings-tab').forEach(function(tab){
    tab.addEventListener('click',function(){
      document.querySelectorAll('.settings-tab').forEach(function(t){t.classList.remove('active')});
      tab.classList.add('active');
      var which=tab.getAttribute('data-settings-tab');
      document.getElementById('settings-general').style.display=which==='general'?'block':'none';
      document.getElementById('settings-features').style.display=which==='features'?'block':'none';
      if(which==='features'&&!window._featuresLoaded){window._featuresLoaded=true;loadFeatures()}
    });
  });

  /* --- Features Guide --- */
  var FEATURE_CATEGORIES=[
    {id:'core',icon:'ğŸ¤–',title:'Core AI',title_kr:'í•µì‹¬ AI',features:[
      {name:'Multi-model Routing',name_kr:'ë©€í‹° ëª¨ë¸ ë¼ìš°íŒ…',desc:'Auto-routes to haiku/sonnet/opus based on complexity',desc_kr:'ë³µì¡ë„ì— ë”°ë¼ haiku/sonnet/opus ìë™ ì„ íƒ',command:'/model'},
      {name:'Extended Thinking',name_kr:'í™•ì¥ ì‚¬ê³ ',desc:'Deep reasoning for complex tasks',desc_kr:'ë³µì¡í•œ ì‘ì—…ì„ ìœ„í•œ ì‹¬ì¸µ ì¶”ë¡ ',command:'/thinking on'},
      {name:'Context Compaction',name_kr:'ì»¨í…ìŠ¤íŠ¸ ì••ì¶•',desc:'Auto-summarize long sessions',desc_kr:'ê¸´ ì„¸ì…˜ ìë™ ìš”ì•½',command:'/compact'},
      {name:'Prompt Caching',name_kr:'í”„ë¡¬í”„íŠ¸ ìºì‹±',desc:'Anthropic cache for cost savings',desc_kr:'Anthropic ìºì‹œë¡œ ë¹„ìš© ì ˆê°',command:'/context'},
      {name:'Self-Evolving Prompt',name_kr:'ìê°€ ì§„í™” í”„ë¡¬í”„íŠ¸',desc:'AI learns your preferences over time',desc_kr:'ëŒ€í™”í• ìˆ˜ë¡ ì„ í˜¸ë„ ìë™ í•™ìŠµ',command:'/evolve status'},
      {name:'Mood-Aware Response',name_kr:'ê¸°ë¶„ ê°ì§€ ì‘ë‹µ',desc:'Adjusts tone based on your emotion',desc_kr:'ê°ì •ì— ë”°ë¼ í†¤ ìë™ ì¡°ì ˆ',command:'/mood on'},
      {name:'A/B Split Response',name_kr:'A/B ë¶„í•  ì‘ë‹µ',desc:'Two perspectives on one question',desc_kr:'í•˜ë‚˜ì˜ ì§ˆë¬¸ì— ë‘ ê´€ì  ë™ì‹œ ì‘ë‹µ',command:'/split'}
    ]},
    {id:'tools',icon:'ğŸ”§',title:'Tools',title_kr:'ë„êµ¬',features:[
      {name:'Web Search',name_kr:'ì›¹ ê²€ìƒ‰',desc:'Search the internet',desc_kr:'ì¸í„°ë„· ê²€ìƒ‰'},
      {name:'Code Execution',name_kr:'ì½”ë“œ ì‹¤í–‰',desc:'Run code with sandbox protection',desc_kr:'ìƒŒë“œë°•ìŠ¤ ë³´í˜¸ í•˜ì— ì½”ë“œ ì‹¤í–‰',command:'/bash'},
      {name:'File Operations',name_kr:'íŒŒì¼ ì‘ì—…',desc:'Read, write, edit files',desc_kr:'íŒŒì¼ ì½ê¸°/ì“°ê¸°/í¸ì§‘'},
      {name:'Browser Automation',name_kr:'ë¸Œë¼ìš°ì € ìë™í™”',desc:'Control Chrome via CDP',desc_kr:'Chrome DevTools Protocol ì œì–´',command:'/screen'},
      {name:'Image Vision',name_kr:'ì´ë¯¸ì§€ ë¶„ì„',desc:'Analyze images with AI',desc_kr:'AIë¡œ ì´ë¯¸ì§€ ë¶„ì„'},
      {name:'TTS / STT',name_kr:'ìŒì„± ì…ì¶œë ¥',desc:'Text-to-speech and speech-to-text',desc_kr:'í…ìŠ¤íŠ¸â†”ìŒì„± ë³€í™˜'},
      {name:'PDF Extraction',name_kr:'PDF ì¶”ì¶œ',desc:'Extract text from PDFs',desc_kr:'PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ'}
    ]},
    {id:'personal',icon:'ğŸ‘¤',title:'Personal Assistant',title_kr:'ê°œì¸ ë¹„ì„œ',features:[
      {name:'Daily Briefing',name_kr:'ë°ì¼ë¦¬ ë¸Œë¦¬í•‘',desc:'Morning/evening digest',desc_kr:'ì•„ì¹¨/ì €ë… ì¢…í•© ë¸Œë¦¬í•‘',command:'/life'},
      {name:'Smart Reminders',name_kr:'ìŠ¤ë§ˆíŠ¸ ë¦¬ë§ˆì¸ë”',desc:'Natural language time parsing',desc_kr:'ìì—°ì–´ ì‹œê°„ íŒŒì‹±'},
      {name:'Expense Tracker',name_kr:'ê°€ê³„ë¶€',desc:'Track spending by category',desc_kr:'ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ì¶”ì '},
      {name:'Pomodoro Timer',name_kr:'í¬ëª¨ë„ë¡œ íƒ€ì´ë¨¸',desc:'25min focus sessions',desc_kr:'25ë¶„ ì§‘ì¤‘ ì„¸ì…˜'},
      {name:'Notes & Links',name_kr:'ë©”ëª¨ & ë§í¬',desc:'Save and search notes/links',desc_kr:'ë©”ëª¨ì™€ ë§í¬ ì €ì¥/ê²€ìƒ‰'},
      {name:'Routines',name_kr:'ë£¨í‹´',desc:'Daily habit tracking',desc_kr:'ì¼ì¼ ìŠµê´€ ì¶”ì '},
      {name:'Google Calendar',name_kr:'êµ¬ê¸€ ìº˜ë¦°ë”',desc:'View, add, delete events',desc_kr:'ì¼ì • ë³´ê¸°/ì¶”ê°€/ì‚­ì œ'},
      {name:'Gmail',name_kr:'ì§€ë©”ì¼',desc:'Read, send, search emails',desc_kr:'ì´ë©”ì¼ ì½ê¸°/ë³´ë‚´ê¸°/ê²€ìƒ‰'},
      {name:'Life Dashboard',name_kr:'ì¸ìƒ ëŒ€ì‹œë³´ë“œ',desc:'All-in-one life overview',desc_kr:'ì›í˜ì´ì§€ ì¸ìƒ í˜„í™©íŒ',command:'/life'}
    ]},
    {id:'unique',icon:'âœ¨',title:'Unique Features',title_kr:'ë…ì ê¸°ëŠ¥',features:[
      {name:'Thought Stream',name_kr:'ìƒê° ìŠ¤íŠ¸ë¦¼',desc:'Quick thought timeline with tags',desc_kr:'í•´ì‹œíƒœê·¸ ê¸°ë°˜ ìƒê° íƒ€ì„ë¼ì¸',command:'/think'},
      {name:'Time Capsule',name_kr:'íƒ€ì„ìº¡ìŠ',desc:'Messages to your future self',desc_kr:'ë¯¸ë˜ì˜ ë‚˜ì—ê²Œ ë³´ë‚´ëŠ” ë©”ì‹œì§€',command:'/capsule'},
      {name:"Dead Man's Switch",name_kr:'ë°ë“œë§¨ ìŠ¤ìœ„ì¹˜',desc:'Emergency actions on inactivity',desc_kr:'ë¹„í™œë™ ì‹œ ê¸´ê¸‰ ì¡°ì¹˜',command:'/deadman'},
      {name:'Shadow Mode',name_kr:'ë¶„ì‹ ìˆ ',desc:'AI replies in your style when away',desc_kr:'ë¶€ì¬ ì‹œ ë‚´ ë§íˆ¬ë¡œ ëŒ€ë¦¬ ì‘ë‹µ',command:'/shadow on'},
      {name:'Encrypted Vault',name_kr:'ë¹„ë°€ ê¸ˆê³ ',desc:'Double-encrypted private chat',desc_kr:'ì´ì¤‘ ì•”í˜¸í™” ë¹„ë°€ ëŒ€í™”',command:'/vault open'},
      {name:'Agent-to-Agent',name_kr:'AIê°„ í†µì‹ ',desc:'Negotiate with other SalmAlm instances',desc_kr:'ë‹¤ë¥¸ SalmAlmê³¼ ìë™ í˜‘ìƒ',command:'/a2a'}
    ]},
    {id:'infra',icon:'âš™ï¸',title:'Infrastructure',title_kr:'ì¸í”„ë¼',features:[
      {name:'Workflow Engine',name_kr:'ì›Œí¬í”Œë¡œìš° ì—”ì§„',desc:'Multi-step automation pipelines',desc_kr:'ë‹¤ë‹¨ê³„ ìë™í™” íŒŒì´í”„ë¼ì¸',command:'/workflow'},
      {name:'MCP Marketplace',name_kr:'MCP ë§ˆì¼“',desc:'One-click MCP server install',desc_kr:'MCP ì„œë²„ ì›í´ë¦­ ì„¤ì¹˜',command:'/mcp catalog'},
      {name:'Plugin System',name_kr:'í”ŒëŸ¬ê·¸ì¸',desc:'Extend with custom plugins',desc_kr:'ì»¤ìŠ¤í…€ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ í™•ì¥'},
      {name:'Multi-Agent',name_kr:'ë‹¤ì¤‘ ì—ì´ì „íŠ¸',desc:'Isolated sub-agents for parallel work',desc_kr:'ë³‘ë ¬ ì‘ì—…ìš© ê²©ë¦¬ ì„œë¸Œì—ì´ì „íŠ¸',command:'/subagents'},
      {name:'Sandboxing',name_kr:'ìƒŒë“œë°•ì‹±',desc:'Docker/subprocess isolation',desc_kr:'Docker/subprocess ê²©ë¦¬ ì‹¤í–‰'},
      {name:'OAuth Auth',name_kr:'OAuth ì¸ì¦',desc:'Anthropic/OpenAI subscription auth',desc_kr:'API í‚¤ ì—†ì´ êµ¬ë… ì¸ì¦',command:'/oauth'},
      {name:'Prompt Caching',name_kr:'í”„ë¡¬í”„íŠ¸ ìºì‹±',desc:'Reduce API costs with caching',desc_kr:'ìºì‹±ìœ¼ë¡œ API ë¹„ìš© ì ˆê°',command:'/context'}
    ]},
    {id:'channels',icon:'ğŸ“±',title:'Channels',title_kr:'ì±„ë„',features:[
      {name:'Web UI',name_kr:'ì›¹ UI',desc:'Full-featured web interface',desc_kr:'í’€ê¸°ëŠ¥ ì›¹ ì¸í„°í˜ì´ìŠ¤'},
      {name:'Telegram',name_kr:'í…”ë ˆê·¸ë¨',desc:'Bot with topics, reactions, groups',desc_kr:'í† í”½/ë°˜ì‘/ê·¸ë£¹ ì§€ì› ë´‡'},
      {name:'Discord',name_kr:'ë””ìŠ¤ì½”ë“œ',desc:'Bot with threads and reactions',desc_kr:'ìŠ¤ë ˆë“œ/ë°˜ì‘ ì§€ì› ë´‡'},
      {name:'Slack',name_kr:'ìŠ¬ë™',desc:'Event API + Web API',desc_kr:'Event API + Web API'},
      {name:'PWA',name_kr:'PWA',desc:'Install as desktop/mobile app',desc_kr:'ë°ìŠ¤í¬í†±/ëª¨ë°”ì¼ ì•± ì„¤ì¹˜'}
    ]},
    {id:'commands',icon:'âŒ¨ï¸',title:'Commands',title_kr:'ëª…ë ¹ì–´',features:[
      {name:'/help',desc:'Show help',desc_kr:'ë„ì›€ë§'},{name:'/status',desc:'Session status',desc_kr:'ì„¸ì…˜ ìƒíƒœ'},
      {name:'/model',desc:'Switch model',desc_kr:'ëª¨ë¸ ì „í™˜'},{name:'/compact',desc:'Compress context',desc_kr:'ì»¨í…ìŠ¤íŠ¸ ì••ì¶•'},
      {name:'/context',desc:'Token breakdown',desc_kr:'í† í° ë¶„ì„'},{name:'/usage',desc:'Token/cost tracking',desc_kr:'í† í°/ë¹„ìš© ì¶”ì '},
      {name:'/think',desc:'Record a thought / set thinking level',desc_kr:'ìƒê° ê¸°ë¡ / ì‚¬ê³  ë ˆë²¨'},
      {name:'/persona',desc:'Switch persona',desc_kr:'í˜ë¥´ì†Œë‚˜ ì „í™˜'},{name:'/branch',desc:'Branch conversation',desc_kr:'ëŒ€í™” ë¶„ê¸°'},
      {name:'/rollback',desc:'Rollback messages',desc_kr:'ë©”ì‹œì§€ ë¡¤ë°±'},{name:'/life',desc:'Life dashboard',desc_kr:'ì¸ìƒ ëŒ€ì‹œë³´ë“œ'},
      {name:'/remind',desc:'Set reminder',desc_kr:'ë¦¬ë§ˆì¸ë” ì„¤ì •'},{name:'/expense',desc:'Track expense',desc_kr:'ì§€ì¶œ ê¸°ë¡'},
      {name:'/pomodoro',desc:'Start pomodoro',desc_kr:'í¬ëª¨ë„ë¡œ ì‹œì‘'},{name:'/note',desc:'Save note',desc_kr:'ë©”ëª¨ ì €ì¥'},
      {name:'/link',desc:'Save link',desc_kr:'ë§í¬ ì €ì¥'},{name:'/routine',desc:'Manage routines',desc_kr:'ë£¨í‹´ ê´€ë¦¬'},
      {name:'/shadow',desc:'Shadow mode',desc_kr:'ë¶„ì‹ ìˆ '},{name:'/vault',desc:'Encrypted vault',desc_kr:'ë¹„ë°€ ê¸ˆê³ '},
      {name:'/capsule',desc:'Time capsule',desc_kr:'íƒ€ì„ìº¡ìŠ'},{name:'/deadman',desc:"Dead man's switch",desc_kr:'ë°ë“œë§¨ ìŠ¤ìœ„ì¹˜'},
      {name:'/a2a',desc:'Agent-to-agent',desc_kr:'AIê°„ í†µì‹ '},{name:'/workflow',desc:'Workflow engine',desc_kr:'ì›Œí¬í”Œë¡œìš°'},
      {name:'/mcp',desc:'MCP management',desc_kr:'MCP ê´€ë¦¬'},{name:'/subagents',desc:'Sub-agents',desc_kr:'ì„œë¸Œì—ì´ì „íŠ¸'},
      {name:'/oauth',desc:'OAuth setup',desc_kr:'OAuth ì„¤ì •'},{name:'/bash',desc:'Run shell command',desc_kr:'ì…¸ ëª…ë ¹ ì‹¤í–‰'},
      {name:'/screen',desc:'Browser control',desc_kr:'ë¸Œë¼ìš°ì € ì œì–´'},{name:'/evolve',desc:'Evolving prompt',desc_kr:'ì§„í™” í”„ë¡¬í”„íŠ¸'},
      {name:'/mood',desc:'Mood detection',desc_kr:'ê°ì • ê°ì§€'},{name:'/split',desc:'A/B split',desc_kr:'A/B ë¶„í• '}
    ]}
  ];

  function loadFeatures(){renderFeatures('')}
  function renderFeatures(q){
    var el=document.getElementById('features-list');
    var empty=document.getElementById('features-empty');
    var kr=_lang==='ko';
    var ql=q.toLowerCase();
    var html='';var total=0;
    FEATURE_CATEGORIES.forEach(function(cat){
      var items=cat.features.filter(function(f){
        if(!ql)return true;
        return (f.name+(f.name_kr||'')+(f.desc||'')+(f.desc_kr||'')+(f.command||'')).toLowerCase().indexOf(ql)>=0;
      });
      if(!items.length)return;
      total+=items.length;
      var open=ql?'open':'';
      html+='<div class="feat-cat '+open+'"><div class="feat-cat-header" onclick="this.parentElement.classList.toggle(\'open\')"><span class="arrow">â–¶</span><span>'+cat.icon+' '+(kr&&cat.title_kr?cat.title_kr:cat.title)+'</span><span style="margin-left:auto;font-size:12px;color:var(--text2)">'+items.length+'</span></div><div class="feat-cat-body">';
      items.forEach(function(f){
        var nm=kr&&f.name_kr?f.name_kr:f.name;
        var ds=kr&&f.desc_kr?f.desc_kr:(f.desc||'');
        html+='<div class="feat-card"><div class="feat-name">'+nm+'</div><div class="feat-desc">'+ds+'</div>';
        if(f.command)html+='<button class="feat-cmd" onclick="document.getElementById(\'input\').value=\''+f.command.replace(/'/g,"\\'")+'\';document.getElementById(\'input\').focus()">'+f.command+'</button>';
        html+='</div>';
      });
      html+='</div></div>';
    });
    el.innerHTML=html;
    empty.style.display=total?'none':'block';
  }
  document.getElementById('features-search').addEventListener('input',function(){renderFeatures(this.value)});

  /* â”€â”€ Users Panel (Multi-tenant) â”€â”€ */
  window.loadUsers=function(){
    fetch('/api/users',{headers:{'Authorization':'Bearer '+(_tok||localStorage.getItem('salm_token')||'')}})
    .then(function(r){return r.json()}).then(function(d){
      if(d.error){document.getElementById('user-list').textContent=d.error;return}
      document.getElementById('mt-toggle').checked=!!d.multi_tenant;
      var sel=document.getElementById('reg-mode');if(sel)sel.value=d.registration_mode||'admin_only';
      var users=d.users||[];
      if(!users.length){document.getElementById('user-list').textContent='No users yet.';return}
      var h='<table style="width:100%;border-collapse:collapse;font-size:12px"><tr style="border-bottom:1px solid var(--border)"><th>User</th><th>Role</th><th>Cost</th><th>Quota (D/M)</th><th>Status</th><th></th></tr>';
      users.forEach(function(u){
        var q=u.quota||{};
        var status=u.enabled?'âœ…':'â›”';
        h+='<tr style="border-bottom:1px solid var(--border);line-height:2.2">';
        h+='<td>'+u.username+'</td><td>'+u.role+'</td>';
        h+='<td>$'+(u.total_cost||0).toFixed(2)+'</td>';
        h+='<td>$'+(q.current_daily||0).toFixed(2)+'/$'+(q.daily_limit||5).toFixed(0)+' / $'+(q.current_monthly||0).toFixed(2)+'/$'+(q.monthly_limit||50).toFixed(0)+'</td>';
        h+='<td>'+status+'</td>';
        h+='<td>';
        if(u.role!=='admin'){
          var toggleLabel=u.enabled?'Disable':'Enable';
          h+='<button onclick="window.toggleUser('+u.id+','+(!u.enabled)+')" style="font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:4px;background:var(--bg3);color:var(--text2);cursor:pointer">'+toggleLabel+'</button> ';
          h+='<button onclick="window.deleteUser(\''+u.username+'\')" style="font-size:11px;padding:2px 8px;border:1px solid var(--red);border-radius:4px;background:var(--bg3);color:var(--red);cursor:pointer">Delete</button>';
        }
        h+='</td></tr>';
      });
      h+='</table>';
      document.getElementById('user-list').innerHTML=h;
    }).catch(function(e){document.getElementById('user-list').textContent='Error: '+e});
  };
  window.createUser=function(){
    var name=document.getElementById('new-user-name').value.trim();
    var pw=document.getElementById('new-user-pw').value;
    var role=document.getElementById('new-user-role').value;
    if(!name||!pw){alert('Username and password required');return}
    fetch('/api/users/register',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(_tok||localStorage.getItem('salm_token')||'')},
      body:JSON.stringify({username:name,password:pw,role:role})})
    .then(function(r){return r.json()}).then(function(d){
      if(d.ok){document.getElementById('new-user-name').value='';document.getElementById('new-user-pw').value='';window.loadUsers()}
      else alert(d.error||'Failed')
    });
  };
  window.toggleUser=function(uid,enabled){
    fetch('/api/users/toggle',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(_tok||localStorage.getItem('salm_token')||'')},
      body:JSON.stringify({user_id:uid,enabled:enabled})})
    .then(function(){window.loadUsers()});
  };
  window.deleteUser=function(username){
    if(!confirm('Delete user '+username+'?'))return;
    fetch('/api/users/delete',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(_tok||localStorage.getItem('salm_token')||'')},
      body:JSON.stringify({username:username})})
    .then(function(){window.loadUsers()});
  };
  document.getElementById('mt-toggle').addEventListener('change',function(){
    fetch('/api/tenant/config',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(_tok||localStorage.getItem('salm_token')||'')},
      body:JSON.stringify({multi_tenant:this.checked})});
  });
  document.getElementById('reg-mode').addEventListener('change',function(){
    fetch('/api/tenant/config',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(_tok||localStorage.getItem('salm_token')||'')},
      body:JSON.stringify({registration_mode:this.value})});
  });

  window.showDashboard=function(){
    chat.style.display='none';inputArea.style.display='none';settingsEl.style.display='none';dashView.style.display='block';
    var dc=document.getElementById('dashboard-content');dc.innerHTML='<p style="color:var(--text2)">Loading...</p>';
    var hdr={'Authorization':'Bearer '+localStorage.getItem('salm_token')};
    fetch('/api/dashboard',{headers:hdr}).then(function(r){return r.json()}).then(function(d){
      var h='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px">';
      h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px"><div style="font-size:12px;color:var(--text2)">TOTAL COST</div><div style="font-size:28px;font-weight:700;color:var(--accent)">$'+(d.total_cost||0).toFixed(4)+'</div></div>';
      h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px"><div style="font-size:12px;color:var(--text2)">TOTAL CALLS</div><div style="font-size:28px;font-weight:700;color:var(--accent)">'+(d.total_calls||0)+'</div></div>';
      h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px"><div style="font-size:12px;color:var(--text2)">UPTIME</div><div style="font-size:28px;font-weight:700;color:var(--accent)">'+(d.uptime_hours||'?')+'h</div></div>';
      h+='</div>';
      if(d.by_model&&Object.keys(d.by_model).length){
        h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px"><h3 style="font-size:13px;color:var(--text2);margin-bottom:12px">MODEL BREAKDOWN</h3><table style="width:100%;font-size:13px;border-collapse:collapse">';
        h+='<tr style="color:var(--text2)"><th style="text-align:left;padding:4px 8px">Model</th><th style="text-align:right;padding:4px 8px">Calls</th><th style="text-align:right;padding:4px 8px">Cost</th></tr>';
        for(var m in d.by_model){var v=d.by_model[m];h+='<tr style="border-top:1px solid var(--border)"><td style="padding:4px 8px">'+m+'</td><td style="text-align:right;padding:4px 8px">'+v.calls+'</td><td style="text-align:right;padding:4px 8px">$'+v.cost.toFixed(4)+'</td></tr>'}
        h+='</table></div>';
      }
      dc.innerHTML=h;
    }).catch(function(e){dc.innerHTML='<p style="color:var(--red)">Failed to load: '+e.message+'</p>'});
    var sb=document.getElementById('sidebar');if(sb&&sb.classList.contains('open'))toggleSidebar();
  };
  window.changePw=function(){
    var o=document.getElementById('pw-old').value,n=document.getElementById('pw-new').value,c=document.getElementById('pw-confirm').value;
    var re=document.getElementById('pw-result');
    if(!o||!n){re.innerHTML='<span style="color:#f87171">'+t('pw-enter-current')+'</span>';return}
    if(n!==c){re.innerHTML='<span style="color:#f87171">'+t('pw-mismatch')+'</span>';return}
    if(n.length<4){re.innerHTML='<span style="color:#f87171">'+t('pw-min4')+'</span>';return}
    fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'change_password',old_password:o,new_password:n})}).then(function(r){return r.json()}).then(function(d){
      if(d.ok){re.innerHTML='<span style="color:#4ade80">'+t('pw-changed')+'</span>';document.getElementById('pw-old').value='';document.getElementById('pw-new').value='';document.getElementById('pw-confirm').value=''}
      else{re.innerHTML='<span style="color:#f87171">'+t('pw-fail')+' '+(d.error||'')+'</span>'}
    }).catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ '+e.message+'</span>'})};
  window.removePw=function(){
    var o=document.getElementById('pw-old').value;var re=document.getElementById('pw-result');
    if(!o){re.innerHTML='<span style="color:#f87171">'+t('pw-enter-current')+'</span>';return}
    fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'change_password',old_password:o,new_password:''})}).then(function(r){return r.json()}).then(function(d){
      if(d.ok){re.innerHTML='<span style="color:#4ade80">âœ… '+t('pw-remove')+'</span>';document.getElementById('pw-old').value='';document.getElementById('pw-section-change').style.display='none';document.getElementById('pw-section-set').style.display='block'}
      else{re.innerHTML='<span style="color:#f87171">'+t('pw-fail')+' '+(d.error||'')+'</span>'}}).catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ '+e.message+'</span>'})};
  window.setPw=function(){
    var n=document.getElementById('pw-set-new').value,c=document.getElementById('pw-set-confirm').value;var re=document.getElementById('pw-result');
    if(!n){re.innerHTML='<span style="color:#f87171">'+t('pw-enter-current')+'</span>';return}
    if(n.length<4){re.innerHTML='<span style="color:#f87171">'+t('pw-min4')+'</span>';return}
    if(n!==c){re.innerHTML='<span style="color:#f87171">'+t('pw-mismatch')+'</span>';return}
    fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'change_password',old_password:'',new_password:n})}).then(function(r){return r.json()}).then(function(d){
      if(d.ok){re.innerHTML='<span style="color:#4ade80">'+t('pw-changed')+'</span>';document.getElementById('pw-set-new').value='';document.getElementById('pw-set-confirm').value='';document.getElementById('pw-section-set').style.display='none';document.getElementById('pw-section-change').style.display='block'}
      else{re.innerHTML='<span style="color:#f87171">'+t('pw-fail')+' '+(d.error||'')+'</span>'}}).catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ '+e.message+'</span>'})};
  window.checkUpdate=function(){
    var re=document.getElementById('update-result');
    re.innerHTML='<span style="color:var(--text2)">â³ Checking PyPI...</span>';
    fetch('/api/check-update').then(function(r){return r.json()}).then(function(d){
      document.getElementById('cur-ver').textContent=d.current;
      if(d.latest&&d.latest!==d.current){
        if(d.exe){
          re.innerHTML='<span style="color:#fbbf24">ğŸ†• New version v'+d.latest+' available!</span> <a href="'+d.download_url+'" target="_blank" style="color:#60a5fa">â¬‡ï¸ Download</a>';
        }else{
          re.innerHTML='<span style="color:#fbbf24">ğŸ†• New version v'+d.latest+' available!</span>';
          document.getElementById('do-update-btn').style.display='inline-block';
        }
      }else{re.innerHTML='<span style="color:#4ade80">âœ… You are up to date (v'+d.current+')</span>';
        document.getElementById('do-update-btn').style.display='none'}
    }).catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ Check failed: '+e.message+'</span>'})};
  window.doUpdate=function(){
    var re=document.getElementById('update-result');
    var btn=document.getElementById('do-update-btn');
    btn.disabled=true;btn.textContent='â³ Installing...';
    re.innerHTML='<span style="color:var(--text2)">Running pip install --upgrade salmalm... (up to 30s)</span>';
    fetch('/api/do-update',{method:'POST'}).then(function(r){return r.json()}).then(function(d){
      if(d.ok){re.innerHTML='<span style="color:#4ade80">âœ… v'+d.version+' Installed! Please restart the server.</span>';
        var rb=document.createElement('button');rb.className='btn';rb.style.marginTop='8px';rb.textContent='ğŸ”„ Restart Now';
        rb.onclick=function(){fetch('/api/restart',{method:'POST'});setTimeout(function(){location.reload()},3000)};re.appendChild(rb);
      }else{re.innerHTML='<span style="color:#f87171">âŒ Failed: '+d.error+'</span>'}
      btn.disabled=false;btn.textContent='â¬†ï¸ Update'})
    .catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ '+e.message+'</span>';btn.disabled=false;btn.textContent='â¬†ï¸ Update'})};
  window.saveKey=function(vaultKey,inputId){
    var v=document.getElementById(inputId).value.trim();
    if(!v){addMsg('assistant','Please enter a key');return}
    fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'set',key:vaultKey,value:v})})
    .then(function(r){return r.json()}).then(function(d){
      var re=document.getElementById('key-test-result');
      re.innerHTML='<span style="color:#4ade80">âœ… '+vaultKey+' Saved</span>';
      document.getElementById(inputId).value='';
      window.showSettings()})};
  window.testKey=function(provider){
    var re=document.getElementById('key-test-result');
    re.innerHTML='<span style="color:var(--text2)">â³ '+provider+' Testing...</span>';
    fetch('/api/test-key',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({provider:provider})})
    .then(function(r){return r.json()}).then(function(d){
      re.innerHTML=d.ok?'<span style="color:#4ade80">'+d.result+'</span>':'<span style="color:#f87171">'+d.result+'</span>'})
    .catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ Error: '+e.message+'</span>'})
  };
  window.googleConnect=function(){
    var re=document.getElementById('google-result');
    re.innerHTML='<span style="color:var(--text2)">â³ Checking credentials...</span>';
    fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get',key:'google_client_id'})})
    .then(function(r){return r.json()}).then(function(d){
      if(!d.value){re.innerHTML='<span style="color:#f87171">'+t('google-no-client-id')+'</span>';return}
      re.innerHTML='<span style="color:#4ade80">'+t('google-redirecting')+'</span>';
      window.open('/api/google/auth','_blank','width=500,height=600')})
    .catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ '+e.message+'</span>'})
  };
  window.googleDisconnect=function(){
    var re=document.getElementById('google-result');
    if(!confirm(t('google-confirm-disconnect')))return;
    Promise.all([
      fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'delete',key:'google_refresh_token'})}),
      fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'delete',key:'google_access_token'})})
    ]).then(function(){
      re.innerHTML='<span style="color:#4ade80">'+t('google-disconnected')+'</span>';
      document.getElementById('google-status').innerHTML='<span style="color:var(--text2)">'+t('google-not-connected')+'</span>';
    }).catch(function(e){re.innerHTML='<span style="color:#f87171">âŒ '+e.message+'</span>'})
  };
  window.checkGoogleStatus=function(){
    var st=document.getElementById('google-status');
    if(!st)return;
    fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get',key:'google_refresh_token'})})
    .then(function(r){return r.json()}).then(function(d){
      if(d.value){st.innerHTML='<span style="color:#4ade80">'+t('google-connected')+'</span>'}
      else{st.innerHTML='<span style="color:var(--text2)">'+t('google-not-connected')+'</span>'}
    }).catch(function(){st.innerHTML=''})
  };
  window.setModel=function(m){modelBadge.textContent=m==='auto'?'auto routing':m.split('/').pop();
    fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:'/model '+(m==='auto'?'auto':m),session:_currentSession})})};

  /* --- Drag highlight --- */
  var ia=document.getElementById('input-area');
  ia.addEventListener('dragenter',function(e){e.preventDefault();ia.classList.add('drag-over')});
  ia.addEventListener('dragover',function(e){e.preventDefault()});
  ia.addEventListener('dragleave',function(){ia.classList.remove('drag-over')});
  ia.addEventListener('drop',function(e){e.preventDefault();ia.classList.remove('drag-over');
    var files=e.dataTransfer.files;if(files.length>0){window.setFile(files[0])}});

  /* --- Scroll to bottom button --- */
  var scrollBtn=document.createElement('button');scrollBtn.id='scroll-bottom';scrollBtn.textContent='â†“';
  document.body.appendChild(scrollBtn);
  chat.addEventListener('scroll',function(){
    var atBottom=chat.scrollHeight-chat.scrollTop-chat.clientHeight<100;
    scrollBtn.style.display=atBottom?'none':'flex';
  });
  scrollBtn.addEventListener('click',function(){chat.scrollTop=chat.scrollHeight});

  /* --- Syntax highlighting (pure JS, no external libs) --- */
  var _hlKeywords={
    javascript:'\b(function|const|let|var|if|else|for|while|return|import|from|export|default|class|new|this|typeof|instanceof|try|catch|finally|throw|async|await|yield|switch|case|break|continue|do|in|of|null|undefined|true|false|void|delete)\b',
    python:'\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|raise|with|yield|async|await|lambda|pass|break|continue|and|or|not|in|is|None|True|False|global|nonlocal|del|assert)\b',
    bash:'\b(if|then|else|elif|fi|for|while|do|done|case|esac|function|return|exit|echo|export|source|alias|local|readonly|shift|eval|exec|trap|set|cd|pwd|ls|cat|grep|sed|awk|find|sudo|apt|pip|npm|git|docker|curl|wget)\b',
    html:'\b(html|head|body|div|span|p|a|img|script|style|link|meta|title|ul|ol|li|table|tr|td|th|form|input|button|select|option|textarea|nav|header|footer|section|article|main|class|id|href|src|type|rel)\b',
    css:'\b(color|background|margin|padding|border|font|display|flex|grid|position|width|height|top|left|right|bottom|opacity|transition|transform|animation|overflow|none|auto|inherit|solid|relative|absolute|fixed|block|inline|important)\b',
    json:''
  };
  function highlightCode(){
    document.querySelectorAll('.bubble pre code').forEach(function(el){
      if(el.dataset.hl)return;el.dataset.hl='1';
      var h=el.innerHTML;
      var lang='';
      var lm=h.match(/^\/\*\s*(\w+)\s*\*\/\n?/);
      if(lm){lang=lm[1].toLowerCase();h=h.replace(lm[0],'')}
      var tokens=[];
      h=h.replace(/(\/\*[\s\S]*?\*\/)/g,function(m){tokens.push('<span class="cmt">'+m+'</span>');return '%%TOK'+(tokens.length-1)+'%%'});
      h=h.replace(/(\/\/.*$|#(?![\da-f]{3,8}\b).*$)/gm,function(m){tokens.push('<span class="cmt">'+m+'</span>');return '%%TOK'+(tokens.length-1)+'%%'});
      h=h.replace(/(&quot;(?:[^&]|&(?!quot;))*?&quot;|"(?:[^"\\]|\\.)*?"|'(?:[^'\\]|\\.)*?'|`(?:[^`\\]|\\.)*?`)/g,function(m){tokens.push('<span class="str">'+m+'</span>');return '%%TOK'+(tokens.length-1)+'%%'});
      h=h.replace(/\b(\d+\.?\d*(?:e[+-]?\d+)?)\b/gi,function(m){return '<span class="num">'+m+'</span>'});
      var kwPattern=_hlKeywords[lang]||_hlKeywords.javascript+'|'+_hlKeywords.python;
      if(kwPattern){h=h.replace(new RegExp(kwPattern,'g'),function(m){return '<span class="kw">'+m+'</span>'})}
      for(var i=0;i<tokens.length;i++){h=h.replace('%%TOK'+i+'%%',tokens[i])}
      el.innerHTML=h;
    });
  }
  var _hlObs=new MutationObserver(highlightCode);
  _hlObs.observe(chat,{childList:true,subtree:true});

  /* --- Keyboard shortcuts + modals --- */
  var _shortcutModal=document.createElement('div');_shortcutModal.id='shortcut-modal';
  _shortcutModal.style.cssText='display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;z-index:10000;min-width:320px;box-shadow:0 20px 60px rgba(0,0,0,0.5)';
  _shortcutModal.innerHTML='<h3 style="margin-bottom:12px;color:var(--accent2)" data-i18n="shortcut-title">\u2328\ufe0f Keyboard Shortcuts</h3><div style="font-size:13px;line-height:2.2;color:var(--text)"><div><kbd style="background:var(--bg3);padding:2px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px">Ctrl+K</kbd> <span data-i18n="shortcut-search">Search sessions</span></div><div><kbd style="background:var(--bg3);padding:2px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px">Ctrl+N</kbd> <span data-i18n="shortcut-newchat">New chat</span></div><div><kbd style="background:var(--bg3);padding:2px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px">Ctrl+Shift+S</kbd> <span data-i18n="shortcut-sidebar">Toggle sidebar</span></div><div><kbd style="background:var(--bg3);padding:2px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px">Escape</kbd> <span data-i18n="shortcut-escape">Close modal / settings</span></div><div><kbd style="background:var(--bg3);padding:2px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px">Ctrl+Shift+P</kbd> <span data-i18n="shortcut-cmdpalette">Command palette</span></div><div><kbd style="background:var(--bg3);padding:2px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px">Ctrl+Shift+P</kbd> <span data-i18n="shortcut-cmdpalette">Command palette</span></div><div><kbd style="background:var(--bg3);padding:2px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px">Ctrl+/</kbd> <span data-i18n="shortcut-help">This help</span></div></div><button data-action="closeShortcutModal" style="margin-top:12px;padding:6px 16px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-size:13px" data-i18n="btn-close">Close</button>';
  document.body.appendChild(_shortcutModal);
  var _shortcutOv=document.createElement('div');_shortcutOv.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999';_shortcutOv.setAttribute('data-action','closeShortcutModal');document.body.appendChild(_shortcutOv);

  var _filterModal=document.createElement('div');_filterModal.id='filter-modal';
  _filterModal.style.cssText='display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px;z-index:10000;min-width:400px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,0.5)';
  _filterModal.innerHTML='<input id="session-filter-input" type="text" data-i18n-ph="filter-ph" placeholder="Search sessions..." style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:14px;outline:none" autocomplete="off"><div id="session-filter-results" style="margin-top:8px;max-height:300px;overflow-y:auto"></div>';
  document.body.appendChild(_filterModal);
  var _filterOv=document.createElement('div');_filterOv.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999';_filterOv.setAttribute('data-action','closeFilterModal');document.body.appendChild(_filterOv);

  function _showFilterModal(){
    _filterModal.style.display='block';_filterOv.style.display='block';
    var fi=document.getElementById('session-filter-input');fi.value='';fi.focus();
    _filterSessions('');fi.oninput=function(){_filterSessions(fi.value)};
  }
  function _filterSessions(q){
    fetch('/api/sessions',{headers:{'X-Session-Token':_tok}}).then(function(r){return r.json()}).then(function(d){
      var el=document.getElementById('session-filter-results');
      if(!d.sessions){el.innerHTML='';return}
      var filtered=q?d.sessions.filter(function(s){return(s.title||s.id).toLowerCase().indexOf(q.toLowerCase())>=0}):d.sessions;
      el.innerHTML=filtered.slice(0,20).map(function(s){
        return '<div style="padding:8px 12px;cursor:pointer;border-radius:6px;font-size:13px;color:var(--text)" data-action="filterSelect" data-sid="'+s.id+'">'+(s.title||s.id)+'</div>';
      }).join('')||'<div style="padding:8px;color:var(--text2);font-size:13px">'+t('filter-no-results')+'</div>';
    });
  }
  function _closeAllModals(){_shortcutModal.style.display='none';_shortcutOv.style.display='none';_filterModal.style.display='none';_filterOv.style.display='none'}

  document.addEventListener('keydown',function(e){
    var tag=document.activeElement&&document.activeElement.tagName;
    var isFilterInput=document.activeElement&&document.activeElement.id==='session-filter-input';
    var isTyping=(tag==='INPUT'||tag==='TEXTAREA')&&!isFilterInput;
    if(e.key==='Escape'){e.preventDefault();
      if(typeof _cmdPalette!=='undefined'&&_cmdPalette&&_cmdPalette.classList.contains&&_cmdPalette.classList.contains('open')){_closeCmdPalette();return}
      if(_searchModal&&_searchModal.classList.contains('open')){_closeSearchModal();return}
      if(_shortcutModal.style.display!=='none'||_filterModal.style.display!=='none'){_closeAllModals();return}
      if(settingsEl.style.display==='block'){showChat();return}return}
    if(isTyping)return;
    var mod=e.ctrlKey||e.metaKey;
    if(mod&&e.shiftKey&&(e.key==='P'||e.key==='p')){e.preventDefault();if(typeof _openCmdPalette==='function')_openCmdPalette();return}
    if(mod&&e.key==='k'){e.preventDefault();_openSearchModal();return}
    if(mod&&e.key==='n'){e.preventDefault();window.newSession();return}
    if(mod&&e.shiftKey&&(e.key==='S'||e.key==='s')){e.preventDefault();toggleSidebar();return}
    if(mod&&e.key==='/'){e.preventDefault();_shortcutModal.style.display='block';_shortcutOv.style.display='block';return}
  });
  document.addEventListener('keydown',function(e){
    if(_filterModal.style.display==='none')return;
    if(e.key==='Enter'){var first=document.querySelector('#session-filter-results [data-sid]');if(first){_closeAllModals();switchSession(first.getAttribute('data-sid'))}}
  });

  /* --- Search Modal (Ctrl+K) â€” full message search --- */
  var _searchModal=document.getElementById('search-modal');
  var _searchInput=document.getElementById('search-input');
  var _searchResults=document.getElementById('search-results');
  var _searchTimer=null;
  function _openSearchModal(){_searchModal.classList.add('open');_searchInput.value='';_searchResults.innerHTML='<div style="padding:16px;text-align:center;color:var(--text2)">'+t('search-type-to-search')+'</div>';_searchInput.focus()}
  function _closeSearchModal(){_searchModal.classList.remove('open')}
  _searchModal.addEventListener('click',function(e){if(e.target===_searchModal)_closeSearchModal()});
  _searchInput.addEventListener('keydown',function(e){
    if(e.key==='Escape'){_closeSearchModal();e.preventDefault()}
    if(e.key==='Enter'){var first=_searchResults.querySelector('.search-item');if(first){var sid=first.getAttribute('data-sid');if(sid){_closeSearchModal();switchSession(sid)}}}
  });
  _searchInput.addEventListener('input',function(){
    clearTimeout(_searchTimer);
    var q=_searchInput.value.trim();
    if(q.length<2){_searchResults.innerHTML='<div style="padding:16px;text-align:center;color:var(--text2)">'+t('search-type-to-search')+'</div>';return}
    _searchTimer=setTimeout(function(){
      fetch('/api/search?q='+encodeURIComponent(q)+'&limit=15',{headers:{'X-Session-Token':_tok}})
      .then(function(r){return r.json()}).then(function(d){
        if(!d.results||!d.results.length){_searchResults.innerHTML='<div style="padding:16px;text-align:center;color:var(--text2)">'+t('search-no-results')+' "'+q+'"</div>';return}
        var html='';
        var re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
        d.results.forEach(function(r){
          var snippet=(r.match_snippet||r.content||'').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(re,'<mark>$1</mark>');
          var icon=r.role==='user'?'ğŸ‘¤':'ğŸ˜ˆ';
          html+='<div class="search-item" data-action="searchGo" data-sid="'+r.session_id+'">'
            +'<div class="sr-session">'+icon+' '+r.session_id+' Â· '+(r.updated_at||'')+'</div>'
            +'<div class="sr-snippet">'+snippet+'</div></div>';
        });
        _searchResults.innerHTML=html;
      }).catch(function(){_searchResults.innerHTML='<div style="padding:16px;text-align:center;color:var(--red)">'+t('search-error')+'</div>'});
    },300);
  });

  /* --- Welcome (only if no history) --- */
  if(!JSON.parse(localStorage.getItem('salm_chat')||'[]').length){
    addMsg('assistant',t('welcome-msg'),'system');
  }
  input.focus();

  /* --- Restore model preference from server --- */
  fetch('/api/status').then(r=>r.json()).then(d=>{
    if(d.model&&d.model!=='auto'){
      var sel=document.getElementById('s-model');
      if(sel){sel.value=d.model;modelBadge.textContent=d.model.split('/').pop()}
    }
  }).catch(()=>{});

  /* --- Notification polling (30s) --- */
  setInterval(async()=>{
    if(!_tok)return;
    try{
      var r=await fetch('/api/notifications',{headers:{'X-Session-Token':_tok}});
      if(!r.ok)return;
      var d=await r.json();
      if(d.notifications&&d.notifications.length){
        d.notifications.forEach(n=>addMsg('assistant',n.text,'notification'));
      }
    }catch(e){}
  },30000);
  /* --- Export menu toggle --- */
  window.toggleExportMenu=function(){var m=document.getElementById('export-menu');m.classList.toggle('open')};
  document.addEventListener('click',function(e){if(!e.target.closest('.export-dropdown')){var m=document.getElementById('export-menu');if(m)m.classList.remove('open')}});
  window.exportMd=function(){document.getElementById('export-menu').classList.remove('open');window.exportChat('md')};
  window.exportJson=function(){document.getElementById('export-menu').classList.remove('open');window.exportChat('json')};
  window.exportServerMd=function(){document.getElementById('export-menu').classList.remove('open');window.open('/api/sessions/'+encodeURIComponent(_currentSession)+'/export?format=md')};
  window.exportServerJson=function(){document.getElementById('export-menu').classList.remove('open');window.open('/api/sessions/'+encodeURIComponent(_currentSession)+'/export?format=json')};

  /* --- Command Palette (Ctrl+Shift+P) --- */
  var _cmdPalette=document.createElement('div');_cmdPalette.id='cmd-palette';
  _cmdPalette.innerHTML='<input id="cmd-input" type="text" placeholder="'+t('cmd-placeholder')+'" autocomplete="off"><div id="cmd-results"></div>';
  document.body.appendChild(_cmdPalette);
  var _cmdOv=document.createElement('div');_cmdOv.id='cmd-overlay';document.body.appendChild(_cmdOv);
  var _cmdCommands=[
    {icon:'ğŸ—¨',label:'cmd-new-chat',action:function(){window.newSession()},shortcut:'Ctrl+N'},
    {icon:'ğŸ“¥',label:'cmd-export',action:function(){window.exportChat('md')}},
    {icon:'âš™ï¸',label:'cmd-settings',action:function(){window.showSettings()}},
    {icon:'ğŸ”',label:'cmd-search',action:function(){_openSearchModal()},shortcut:'Ctrl+K'},
    {icon:'ğŸ¨',label:'cmd-theme',action:function(){window.toggleTheme()}},
    {icon:'â˜°',label:'cmd-sidebar',action:function(){window.toggleSidebar()}},
    {icon:'ğŸ“ˆ',label:'cmd-dashboard',action:function(){window.showDashboard()}},
    {icon:'ğŸ¤–',label:'/model',action:function(){input.value='/model ';input.focus()},raw:true},
    {icon:'ğŸ§ ',label:'/thinking',action:function(){window.toggleThinking()},raw:true},
    {icon:'ğŸ“¦',label:'/compact',action:function(){input.value='/compact';doSend()},raw:true},
    {icon:'âª',label:'/rollback',action:function(){input.value='/rollback';doSend()},raw:true},
    {icon:'ğŸŒ¿',label:'/branch',action:function(){input.value='/branch';doSend()},raw:true},
    {icon:'ğŸ“œ',label:'/soul',action:function(){input.value='/soul';doSend()},raw:true},
    {icon:'ğŸ”Š',label:'/tts',action:function(){input.value='/tts ';input.focus()},raw:true},
    {icon:'ğŸ¤',label:'/voice',action:function(){window.toggleMic()},raw:true},
    {icon:'â“',label:'/help',action:function(){input.value='/help';doSend()},raw:true},
  ];
  var _cmdSel=0;
  function _fuzzyMatch(query,text){query=query.toLowerCase();text=text.toLowerCase();if(!query)return true;var qi=0;for(var ti=0;ti<text.length&&qi<query.length;ti++){if(text[ti]===query[qi])qi++}return qi===query.length}
  function _renderCmdResults(q){
    var el=document.getElementById('cmd-results');
    var filtered=_cmdCommands.filter(function(c){var label=c.raw?c.label:t(c.label);return _fuzzyMatch(q,label)||_fuzzyMatch(q,c.icon+' '+label)});
    _cmdSel=0;
    el.innerHTML=filtered.map(function(c,i){
      var label=c.raw?c.label:t(c.label);
      var sc=c.shortcut?'<span class="cmd-shortcut">'+c.shortcut+'</span>':'';
      return '<div class="cmd-item'+(i===0?' selected':'')+'" data-cmd-idx="'+i+'"><span class="cmd-icon">'+c.icon+'</span><span class="cmd-label">'+label+'</span>'+sc+'</div>';
    }).join('');
    el._filtered=filtered;
  }
  function _openCmdPalette(){_cmdPalette.classList.add('open');_cmdOv.classList.add('open');var ci=document.getElementById('cmd-input');ci.value='';ci.focus();_renderCmdResults('');ci.oninput=function(){_renderCmdResults(ci.value)}}
  function _closeCmdPalette(){_cmdPalette.classList.remove('open');_cmdOv.classList.remove('open')}
  _cmdOv.addEventListener('click',_closeCmdPalette);
  document.addEventListener('keydown',function(e){
    if(!_cmdPalette||!_cmdPalette.classList.contains('open'))return;
    var el=document.getElementById('cmd-results');var filtered=el._filtered||[];
    var items=el.querySelectorAll('.cmd-item');
    if(e.key==='ArrowDown'){e.preventDefault();_cmdSel=Math.min(_cmdSel+1,items.length-1);items.forEach(function(it,i){it.classList.toggle('selected',i===_cmdSel)})}
    else if(e.key==='ArrowUp'){e.preventDefault();_cmdSel=Math.max(_cmdSel-1,0);items.forEach(function(it,i){it.classList.toggle('selected',i===_cmdSel)})}
    else if(e.key==='Enter'){e.preventDefault();if(filtered[_cmdSel]){_closeCmdPalette();filtered[_cmdSel].action()}}
  });
  document.getElementById('cmd-results').addEventListener('click',function(e){
    var item=e.target.closest('.cmd-item');if(!item)return;
    var idx=parseInt(item.getAttribute('data-cmd-idx'));
    var el=document.getElementById('cmd-results');var filtered=el._filtered||[];
    if(filtered[idx]){_closeCmdPalette();filtered[idx].action();}
  });

  /* --- PWA Install Prompt --- */
  var _deferredPrompt=null;
  var _pwaBanner=document.createElement('div');_pwaBanner.id='pwa-install';
  _pwaBanner.innerHTML='<span>ğŸ˜ˆ '+t('pwa-install-text')+'</span><button class="install-btn" data-action="pwaInstall">'+t('pwa-install-btn')+'</button><button class="dismiss-btn" data-action="pwaDismiss">'+t('pwa-dismiss')+'</button>';
  document.body.appendChild(_pwaBanner);
  window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();_deferredPrompt=e;if(!localStorage.getItem('pwa-dismissed'))_pwaBanner.classList.add('show')});
  window.pwaInstall=function(){if(_deferredPrompt){_deferredPrompt.prompt();_deferredPrompt.userChoice.then(function(){_deferredPrompt=null;_pwaBanner.classList.remove('show')})}};
  window.pwaDismiss=function(){_pwaBanner.classList.remove('show');localStorage.setItem('pwa-dismissed','1')};

  applyLang();

  /* --- CSP-safe event delegation --- */
  var _qcMap={'qc-help':'/help','qc-sysmon':'Check system status','qc-memory':'Show memory files',
    'qc-cost':'Show cost report','qc-cron':'Show cron jobs','qc-python':'Calculate 1+1 in Python',
    'qc-image':'Generate image: a cat in galaxy','qc-tts':'Convert to speech: Hello world'};
  document.addEventListener('click',function(e){
    var el=e.target.closest('[data-action]');if(!el)return;
    var a=el.getAttribute('data-action');
    if(a==='newSession')window.newSession();
    else if(a==='showChat')window.showChat();
    else if(a==='showSettings')window.showSettings();
    else if(a==='showUsage')window.showSettings();
    else if(a==='showDashboard')window.showDashboard();
    else if(a==='toggleSidebar')window.toggleSidebar();
    else if(a==='toggleTheme')window.toggleTheme();
    else if(a==='openDashboard')window.showDashboard();
    else if(a==='exportChat')window.exportChat('md');
    else if(a==='toggleExportMenu')window.toggleExportMenu();
    else if(a==='exportMd')window.exportMd();
    else if(a==='exportJson')window.exportJson();
    else if(a==='exportServerMd')window.exportServerMd();
    else if(a==='exportServerJson')window.exportServerJson();
    else if(a==='pwaInstall')window.pwaInstall();
    else if(a==='pwaDismiss')window.pwaDismiss();
    else if(a==='toggleThinking')window.toggleThinking();
    else if(a==='toggleMic')window.toggleMic();
    else if(a==='clearFile')window.clearFile();
    else if(a==='toggleTools'){var nx=el.nextElementSibling;nx.style.display=nx.style.display==='none'?'block':'none'}
    else if(a.startsWith('qc-'))window.quickCmd(_qcMap[a]);
    else if(a==='save-anthropic')window.saveKey('anthropic_api_key','sk-anthropic');
    else if(a==='test-anthropic')window.testKey('anthropic');
    else if(a==='save-openai')window.saveKey('openai_api_key','sk-openai');
    else if(a==='test-openai')window.testKey('openai');
    else if(a==='save-xai')window.saveKey('xai_api_key','sk-xai');
    else if(a==='test-xai')window.testKey('xai');
    else if(a==='save-google')window.saveKey('google_api_key','sk-google');
    else if(a==='test-google')window.testKey('google');
    else if(a==='save-brave')window.saveKey('brave_api_key','sk-brave');
    else if(a==='save-google-client-id')window.saveKey('google_client_id','sk-google-client-id');
    else if(a==='save-google-client-secret')window.saveKey('google_client_secret','sk-google-client-secret');
    else if(a==='googleConnect')window.googleConnect();
    else if(a==='googleDisconnect')window.googleDisconnect();
    else if(a==='changePw')window.changePw();
    else if(a==='removePw')window.removePw();
    else if(a==='setPw')window.setPw();
    else if(a==='checkUpdate')window.checkUpdate();
    else if(a==='doUpdate')window.doUpdate();
    else if(a==='exportAgent')window.exportAgent();
    else if(a==='importAgent')window.importAgent();
    else if(a==='quickSyncExport')window.quickSyncExport();
    else if(a==='saveOllama'){var u=document.getElementById('s-ollama-url').value;fetch('/api/vault',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'set',key:'ollama_url',value:u})}).then(function(){addMsg('assistant','âœ… Saved')})}
    else if(a==='saveRouting'){var rc={simple:document.getElementById('route-simple').value,moderate:document.getElementById('route-moderate').value,complex:document.getElementById('route-complex').value};fetch('/api/routing',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},body:JSON.stringify(rc)}).then(function(r){return r.json()}).then(function(d){var st=document.getElementById('route-status');if(st){st.textContent='âœ… Saved!';setTimeout(function(){st.textContent=''},2000)}}).catch(function(){var st=document.getElementById('route-status');if(st)st.textContent='âŒ Error'})}
    else if(a==='saveSoul'){
      var sc=document.getElementById('soul-editor').value;
      fetch('/api/soul',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},body:JSON.stringify({content:sc})}).then(function(r){return r.json()}).then(function(d){
        document.getElementById('soul-result').innerHTML='<span style="color:#4ade80">'+(d.message||'Saved')+'</span>'})
    }
    else if(a==='resetSoul'){
      document.getElementById('soul-editor').value='';
      fetch('/api/soul',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},body:JSON.stringify({content:''})}).then(function(r){return r.json()}).then(function(d){
        document.getElementById('soul-result').innerHTML='<span style="color:#4ade80">'+(d.message||'Reset')+'</span>'})
    }
    else if(a==='reloadPlugins'){fetch('/api/plugins/manage',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},body:JSON.stringify({action:'reload'})}).then(function(){window.showSettings()})}
    else if(a==='reloadHooks'){fetch('/api/hooks',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},body:JSON.stringify({action:'reload'})}).then(function(){window.showSettings()})}
    else if(a==='closeShortcutModal'||a==='closeFilterModal'){_closeAllModals()}
    else if(a==='filterSelect'){_closeAllModals();switchSession(el.getAttribute('data-sid'))}
    else if(a==='switchSession'){e.stopPropagation();window.switchSession(el.getAttribute('data-sid'))}
    else if(a==='deleteSession'){e.stopPropagation();window.deleteSession(el.getAttribute('data-sid'))}
    else if(a==='copyCode'){var cid=el.getAttribute('data-copy-id');window.copyCode(cid)}
    else if(a==='searchGo'){var sid=el.getAttribute('data-sid');if(sid){_closeSearchModal();switchSession(sid)}}
    else if(a==='openImage')window.open(el.src);
    else if(a==='save'&&typeof save==='function')save();
    else if(a==='reload')location.reload();
    else if(a==='pickTrue'&&typeof pick==='function')pick(true);
    else if(a==='pickFalse'&&typeof pick==='function')pick(false);
    else if(a==='go'&&typeof go==='function')go();
    else if(a==='unlock'&&typeof unlock==='function')unlock();
  });
  document.addEventListener('change',function(e){
    var el=e.target.closest('[data-action]');if(!el)return;
    var a=el.getAttribute('data-action');
    if(a==='setLang')window.setLang(el.value);
    else if(a==='setModel')window.setModel(el.value);
  });
  document.addEventListener('keydown',function(e){
    if(e.key!=='Enter')return;
    var el=e.target.closest('[data-enter-action]');if(!el)return;
    var a=el.getAttribute('data-enter-action');
    if(a==='go'&&typeof go==='function')go();
    else if(a==='unlock'&&typeof unlock==='function')unlock();
  });

  /* STT â€” Voice Input */
  /* --- Extended Thinking Toggle --- */
  var _thinkingOn=false;
  window.toggleThinking=function(){
    _thinkingOn=!_thinkingOn;
    var btn=document.getElementById('thinking-btn');
    if(_thinkingOn){
      btn.style.background='var(--accent)';btn.style.color='#fff';
      fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
        body:JSON.stringify({message:'/thinking on',session:_currentSession})}).catch(function(){});
      addMsg('system',t('thinking-on'));
    }else{
      btn.style.background='var(--bg3)';btn.style.color='var(--text2)';
      fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
        body:JSON.stringify({message:'/thinking off',session:_currentSession})}).catch(function(){});
      addMsg('system',t('thinking-off'));
    }
  };

  var _mediaRec=null,_audioChunks=[];
  window.toggleMic=function(){
    var btn=document.getElementById('mic-btn');
    if(_mediaRec&&_mediaRec.state==='recording'){
      _mediaRec.stop();
      btn.style.background='var(--bg3)';btn.style.color='var(--text2)';
      return;
    }
    navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){
      _audioChunks=[];
      _mediaRec=new MediaRecorder(stream,{mimeType:'audio/webm'});
      _mediaRec.ondataavailable=function(e){if(e.data.size>0)_audioChunks.push(e.data)};
      _mediaRec.onstop=function(){
        stream.getTracks().forEach(function(t){t.stop()});
        var blob=new Blob(_audioChunks,{type:'audio/webm'});
        var reader=new FileReader();
        reader.onload=function(){
          var b64=reader.result.split(',')[1];
          btn.textContent='â³';
          fetch('/api/stt',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
            body:JSON.stringify({audio_base64:b64,language:'ko'})})
          .then(function(r){return r.json()})
          .then(function(d){
            if(d.text){
              var inp=document.getElementById('input');
              inp.value=(inp.value?inp.value+' ':'')+d.text;
              inp.focus();inp.dispatchEvent(new Event('input'));
            }
            btn.textContent='ğŸ¤';
          }).catch(function(){btn.textContent='ğŸ¤'});
        };
        reader.readAsDataURL(blob);
      };
      _mediaRec.start();
      btn.style.background='var(--red)';btn.style.color='#fff';
    }).catch(function(){addMsg('assistant',t('mic-denied'))});
  };

  /* --- Double-click to rename session title --- */
  document.addEventListener('dblclick',function(e){
    var el=e.target.closest('.session-title');if(!el)return;
    e.stopPropagation();
    var sid=el.getAttribute('data-sid');
    var oldTitle=el.textContent.replace(/^â†³ /,'');
    var inp=document.createElement('input');
    inp.type='text';inp.value=oldTitle;
    inp.style.cssText='width:100%;padding:2px 4px;border:1px solid var(--accent);border-radius:4px;background:var(--bg);color:var(--text);font-size:12px;outline:none';
    el.textContent='';el.appendChild(inp);inp.focus();inp.select();
    function save(){
      var newTitle=inp.value.trim()||oldTitle;
      el.textContent=newTitle;
      if(newTitle!==oldTitle){
        fetch('/api/sessions/rename',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},
          body:JSON.stringify({session_id:sid,title:newTitle})}).catch(function(){});
      }
    }
    inp.addEventListener('blur',save);
    inp.addEventListener('keydown',function(ev){if(ev.key==='Enter'){ev.preventDefault();inp.blur()}if(ev.key==='Escape'){inp.value=oldTitle;inp.blur()}});
  });

  /* Auto-check for updates on load */
  setTimeout(function(){
    fetch('/api/update/check').then(function(r){return r.json()}).then(function(d){
      if(d.update_available&&d.latest){
        var banner=document.getElementById('update-banner');
        if(banner){banner.style.display='flex';document.getElementById('banner-ver').textContent='v'+d.latest+' available';}
      }
    }).catch(function(){});
  },3000);

  /* --- Agent Migration (ì—ì´ì „íŠ¸ ì´ë™) --- */
  window.exportAgent=function(){
    var s=document.getElementById('exp-sessions').checked?'1':'0';
    var d=document.getElementById('exp-data').checked?'1':'0';
    var v=document.getElementById('exp-vault').checked?'1':'0';
    window.open('/api/agent/export?sessions='+s+'&data='+d+'&vault='+v,'_blank');
  };
  window.quickSyncExport=function(){
    fetch('/api/agent/sync',{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':_tok},body:JSON.stringify({action:'export'})})
    .then(function(r){return r.json()}).then(function(d){
      if(d.ok){var blob=new Blob([JSON.stringify(d.data,null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='salmalm-quick-sync.json';a.click()}
    });
  };
  var _importZipData=null;
  var dropzone=document.getElementById('import-dropzone');
  if(dropzone){
    dropzone.addEventListener('dragover',function(e){e.preventDefault();dropzone.style.borderColor='var(--accent)'});
    dropzone.addEventListener('dragleave',function(){dropzone.style.borderColor='var(--border)'});
    dropzone.addEventListener('drop',function(e){e.preventDefault();dropzone.style.borderColor='var(--border)';if(e.dataTransfer.files[0])_handleImportFile(e.dataTransfer.files[0])});
  }
  var impInput=document.getElementById('import-file-input');
  if(impInput)impInput.addEventListener('change',function(){if(this.files[0])_handleImportFile(this.files[0]);this.value=''});
  function _handleImportFile(file){
    if(!file.name.endsWith('.zip')){document.getElementById('import-result').textContent='âŒ Please select a ZIP file';return}
    var reader=new FileReader();
    reader.onload=function(){
      _importZipData=reader.result;
      document.getElementById('import-btn').disabled=false;
      /* Preview */
      var fd=new FormData();fd.append('file',file);
      fetch('/api/agent/import/preview',{method:'POST',headers:{'X-Session-Token':_tok},body:fd})
      .then(function(r){return r.json()}).then(function(d){
        var prev=document.getElementById('import-preview');
        if(d.ok){
          var m=d.manifest||{};
          prev.innerHTML='<strong>'+file.name+'</strong> ('+Math.round(d.size_bytes/1024)+'KB)<br>'+
            'Agent: '+(m.agent_name||'?')+' Â· v'+(m.version||'?')+'<br>'+
            'Sections: '+(d.sections||[]).join(', ')+'<br>'+
            'Files: '+d.file_count;
          prev.style.display='block';
        }else{prev.textContent='âš ï¸ '+(d.error||'Preview failed');prev.style.display='block'}
      }).catch(function(){});
    };
    reader.readAsArrayBuffer(file);
  }
  window.importAgent=function(){
    if(!_importZipData)return;
    var mode=document.getElementById('import-mode').value;
    var blob=new Blob([_importZipData],{type:'application/zip'});
    var fd=new FormData();fd.append('file',blob,'agent-export.zip');fd.append('conflict_mode',mode);
    document.getElementById('import-result').textContent='â³ Importing...';
    fetch('/api/agent/import',{method:'POST',headers:{'X-Session-Token':_tok},body:fd})
    .then(function(r){return r.json()}).then(function(d){
      var res=document.getElementById('import-result');
      if(d.ok){res.innerHTML='âœ… Imported: '+(d.imported||[]).join(', ')+(d.warnings&&d.warnings.length?' <br>âš ï¸ '+d.warnings.join('; '):'')}
      else{res.textContent='âŒ '+(d.errors||[]).join('; ')||(d.error||'Import failed')}
      _importZipData=null;document.getElementById('import-btn').disabled=true;
    }).catch(function(e){document.getElementById('import-result').textContent='âŒ '+e});
  };

  /* PWA Service Worker */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').catch(function(){});
  }
})();
</script></body></html>